var rudderanalytics=function(e){"use strict";function t(e){return null!=e&&"object"==typeof e&&!0===e["@@functional/placeholder"]}function n(e){return function n(s){return 0===arguments.length||t(s)?n:e.apply(this,arguments)}}function s(e){return function s(i,r){switch(arguments.length){case 0:return s;case 1:return t(i)?s:n(function(t){return e(i,t)});default:return t(i)&&t(r)?s:t(i)?n(function(t){return e(t,r)}):t(r)?n(function(t){return e(i,t)}):e(i,r)}}}function i(e){return function i(r,o,a){switch(arguments.length){case 0:return i;case 1:return t(r)?i:s(function(t,n){return e(r,t,n)});case 2:return t(r)&&t(o)?i:t(r)?s(function(t,n){return e(t,o,n)}):t(o)?s(function(t,n){return e(r,t,n)}):n(function(t){return e(r,o,t)});default:return t(r)&&t(o)&&t(a)?i:t(r)&&t(o)?s(function(t,n){return e(t,n,a)}):t(r)&&t(a)?s(function(t,n){return e(t,o,n)}):t(o)&&t(a)?s(function(t,n){return e(r,t,n)}):t(r)?n(function(t){return e(t,o,a)}):t(o)?n(function(t){return e(r,t,a)}):t(a)?n(function(t){return e(r,o,t)}):e(r,o,a)}}}function r(e,t){return Object.prototype.hasOwnProperty.call(t,e)}var o=n(function(e){return null===e?"Null":void 0===e?"Undefined":Object.prototype.toString.call(e).slice(8,-1)});function a(e){return"[object Object]"===Object.prototype.toString.call(e)}const l=Number.isInteger||function(e){return(e|0)===e};function u(e,t){return t[e<0?t.length+e:e]}function c(e,t,n){if(n||(n=new d),function(e){var t=typeof e;return null==e||"object"!=t&&"function"!=t}(e))return e;var s,i=function(t){var s=n.get(e);if(s)return s;for(var i in n.set(e,t),e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=c(e[i],!0,n));return t};switch(o(e)){case"Object":return i(Object.create(Object.getPrototypeOf(e)));case"Array":return i(Array(e.length));case"Date":return new Date(e.valueOf());case"RegExp":return s=e,new RegExp(s.source,s.flags?s.flags:(s.global?"g":"")+(s.ignoreCase?"i":"")+(s.multiline?"m":"")+(s.sticky?"y":"")+(s.unicode?"u":"")+(s.dotAll?"s":""));case"Int8Array":case"Uint8Array":case"Uint8ClampedArray":case"Int16Array":case"Uint16Array":case"Int32Array":case"Uint32Array":case"Float32Array":case"Float64Array":case"BigInt64Array":case"BigUint64Array":return e.slice();default:return e}}var d=function(){function e(){this.map={},this.length=0}return e.prototype.set=function(e,t){var n=this.hash(e),s=this.map[n];s||(this.map[n]=s=[]),s.push([e,t]),this.length+=1},e.prototype.hash=function(e){var t=[];for(var n in e)t.push(Object.prototype.toString.call(e[n]));return t.join()},e.prototype.get=function(e){if(this.length<=180)for(var t in this.map)for(var n=this.map[t],s=0;s<n.length;s+=1){if((r=n[s])[0]===e)return r[1]}else{var i=this.hash(e);if(n=this.map[i])for(s=0;s<n.length;s+=1){var r;if((r=n[s])[0]===e)return r[1]}}},e}(),g=n(function(e){return null!=e&&"function"==typeof e.clone?e.clone():c(e)});function h(e,t){for(var n=t,s=0;s<e.length;s+=1){if(null==n)return;var i=e[s];n=l(i)?u(i,n):n[i]}return n}var p=i(function(e,t,n){var s,i={};for(s in n=n||{},t=t||{})r(s,t)&&(i[s]=r(s,n)?e(s,t[s],n[s]):t[s]);for(s in n)r(s,n)&&!r(s,i)&&(i[s]=n[s]);return i}),v=i(function e(t,n,s){return p(function(n,s,i){return a(s)&&a(i)?e(t,s,i):t(n,s,i)},n,s)}),f=i(function(e,t,n){return v(function(t,n,s){return e(n,s)},t,n)}),y=s(h),m=s(function(e,t){var n={};for(var s in t)e(t[s],s,t)&&(n[s]=t[s]);return n});const b=e=>"function"==typeof e&&Boolean(e.constructor&&e.call&&e.apply),k=e=>"string"==typeof e,I=e=>null===e,S=e=>void 0===e,E=e=>I(e)||S(e),T=e=>!S(e),A=e=>!E(e),w=e=>{switch(Object.prototype.toString.call(e)){case"[object Error]":case"[object Exception]":case"[object DOMException]":return!0;default:return e instanceof Error}},C=(e,t)=>{const n=t.split(".");return y(n,e)},$=e=>!I(e)&&"[object Object]"===Object.prototype.toString.call(e),P=(e,t)=>{if(!Array.isArray(e)||!Array.isArray(t))return g(t);const n=g(e);return t.forEach((e,t)=>{n[t]=Array.isArray(e)||(e=>!I(e)&&(e=>"object"==typeof e)(e)&&!Array.isArray(e))(e)?O(n[t],e):e}),n},O=(e,t)=>f(P,e,t),D=e=>$(e)&&Object.keys(e).length>0,R=e=>{const t=m(T,e);return Object.keys(t).forEach(e=>{const n=t[e];$(n)&&(t[e]=R(n))}),t},N=e=>{const t=m(A,e);return Object.keys(t).forEach(e=>{const n=t[e];$(n)&&(t[e]=N(n))}),t},M=e=>{if(D(e))return N(e)},L=(e,t)=>"boolean"==typeof e?e:t,B=e=>(Object.getOwnPropertyNames(e).forEach(function(t){e[t]&&"object"==typeof e[t]&&B(e[t])}),Object.freeze(e)),x=e=>e.replace(/^\.+/,""),U=e=>{let t=e;if(!k(e)&&!E(e))try{t=JSON.stringify(e)}catch(e){t=null}return t},j=e=>(e=>{const t=Array.from(e,e=>String.fromCodePoint(e)).join("");return globalThis.btoa(t)})((new TextEncoder).encode(e)),_=(e,t,n,s,i)=>{const r={category:e,name:t,properties:n,options:s,callback:void 0};b(i)&&(r.callback=i),b(s)&&(r.category=e,r.name=t,r.properties=n,r.options=void 0,r.callback=s),b(n)&&(r.category=e,r.name=t,r.properties=void 0,r.options=void 0,r.callback=n),b(t)&&(r.category=e,r.name=void 0,r.properties=void 0,r.options=void 0,r.callback=t),b(e)&&(r.category=void 0,r.name=void 0,r.properties=void 0,r.options=void 0,r.callback=e),$(e)?(r.name=void 0,r.category=void 0,r.properties=e,b(t)?r.options=void 0:r.options=t):$(t)&&(r.name=void 0,r.properties=t,b(n)?r.options=void 0:r.options=n),k(e)&&!k(t)&&(r.category=void 0,r.name=e),T(r.category)||(r.category=void 0),T(r.name)||(r.name=void 0),r.properties=r.properties?g(r.properties):{},T(r.options)?r.options=g(r.options):r.options=void 0;const o=k(r.name)?r.name:r.properties.name,a=k(r.category)?r.category:r.properties.category;return r.properties=O($(r.properties)?r.properties:{},{...o&&{name:o},...a&&{category:a}}),r},H=(e,t,n,s)=>{const i={name:e,properties:t,options:n,callback:void 0};return b(s)&&(i.callback=s),b(n)&&(i.properties=t,i.options=void 0,i.callback=n),b(t)&&(i.properties=void 0,i.options=void 0,i.callback=t),i.properties=A(i.properties)?g(i.properties):{},T(i.options)?i.options=g(i.options):i.options=void 0,i},F=(e,t,n,s)=>{const i={userId:e,traits:t,options:n,callback:void 0};return b(s)&&(i.callback=s),b(n)&&(i.userId=e,i.traits=t,i.options=void 0,i.callback=n),b(t)&&(i.userId=e,i.traits=void 0,i.options=void 0,i.callback=t),($(e)||I(e))&&(i.userId=null,i.traits=e,b(t)?i.options=void 0:i.options=t),i.userId=U(i.userId),$(i.traits)?i.traits=g(i.traits):i.traits=void 0,T(i.options)?i.options=g(i.options):i.options=void 0,i},G=(e,t,n,s)=>{const i={to:e,from:t,options:n,callback:void 0};return b(s)&&(i.callback=s),b(n)&&(i.to=e,i.from=t,i.options=void 0,i.callback=n),b(t)?(i.to=e,i.from=void 0,i.options=void 0,i.callback=t):($(t)||I(t))&&(i.to=e,i.from=void 0,i.options=t),T(i.to)&&(i.to=U(i.to)),T(i.from)?i.from=U(i.from):i.from=void 0,T(i.options)?i.options=g(i.options):i.options=void 0,i},K=(e,t,n,s)=>{const i={groupId:e,traits:t,options:n,callback:void 0};return b(s)&&(i.callback=s),b(n)&&(i.groupId=e,i.traits=t,i.options=void 0,i.callback=n),b(t)&&(i.groupId=e,i.traits=void 0,i.options=void 0,i.callback=t),($(e)||I(e))&&(i.groupId=null,i.traits=e,b(t)?i.options=void 0:i.options=t),i.groupId=U(i.groupId),$(i.traits)?i.traits=g(i.traits):i.traits=void 0,T(i.options)?i.options=g(i.options):i.options=void 0,i};let V=function(e){return e.UNLOADED="Page Unloaded",e}({});const z="API",Q="CapabilitiesManager",q="ConfigManager",W="EventManager",J="PluginsManager",X="UserSessionManager",Z="ErrorHandler",Y="PluginEngine",ee=`Ready${z}`,te=`Load${z}`,ne="AnalyticsCore";for(var se,ie=[],re=0;re<256;re++)ie[re]=(re+256).toString(16).substring(1);function oe(){var e;(!se||re+16>4096)&&(e=4096,se=crypto.getRandomValues(new Uint8Array(e)),re=0);for(var t,n=0,s="";n<16;n++)t=se[re+n],s+=6==n?ie[15&t|64]:8==n?ie[63&t|128]:ie[t],1&n&&n>1&&n<11&&(s+="-");return re+=16,s}for(var ae,le=256,ue=[];le--;)ue[le]=(le+256).toString(16).substring(1);const ce=()=>!E(globalThis.crypto)&&b(globalThis.crypto.getRandomValues)?oe():function(){var e,t=0,n="";if(!ae||le+16>256){for(ae=Array(t=256);t--;)ae[t]=256*Math.random()|0;t=le=0}for(;t<16;t++)e=ae[le+t],n+=6==t?ue[15&e|64]:8==t?ue[63&e|128]:ue[e],1&t&&t>1&&t<11&&(n+="-");return le++,n}(),de=()=>k(globalThis.navigator.userAgent)&&/Trident.*rv:11\./.test(globalThis.navigator.userAgent),ge=e=>e.toISOString(),he=":: ",pe=(e,t,n)=>`Unable to load (${k(n)?n:n.type}) the script with the id "${e}" from URL "${t}"`,ve="[Circular Reference]",fe=(e,t,n)=>{const s=[];return function(i,r){if(!(t?.includes(i)||e&&E(r))){if("object"!=typeof r||I(r))return r;for(;s.length>0&&s[s.length-1]!==this;)s.pop();return s.includes(r)?(n?.warn(((e,t)=>`${e}${he}A circular reference has been detected in the object and the property "${t}" has been dropped from the output.`)("JSONStringify",i)),ve):(s.push(r),r)}}},ye=(e,t,n,s)=>{try{return JSON.stringify(e,fe(t,n,s))}catch(e){return s?.warn("Failed to convert the value to a JSON string.",e),null}},me=e=>{const t=[];return function(e,n){if((e=>"bigint"==typeof e)(n))return"[BigInt]";for(;t.length>0&&t[t.length-1]!==this;)t.pop();return t.includes(n)?ve:(t.push(n),n)}},be=(e,t)=>{const n=Array.isArray(e)?[]:{};for(const s in e)if(Object.hasOwnProperty.call(e,s)){const i=e[s],r=t.call(e,s,i);$(r)||Array.isArray(r)?n[s]=be(r,t):n[s]=r}return n},ke=(e,t)=>{const n=me(),s=n.call(e,"",e);return $(e)||Array.isArray(e)?be(e,n):s},Ie="[SDK DISPATCHED ERROR]",Se=e=>{const{stack:t,stacktrace:n,"opera#sourceloc":s}=e,i=t??n??s;if(i&&"string"==typeof i)return i},Ee=(e,t)=>{if(!w(e))return new Error(`${t}: ${ye(e)}`);try{const n=new(0,e.constructor)(`${t}: ${e.message}`),s=Se(e);return s&&(n.stack=s),Object.getOwnPropertyNames(e).forEach(t=>{if("message"!==t&&"stack"!==t&&"name"!==t)try{n[t]=e[t]}catch{}}),n}catch{return new Error(`${t}: ${ye(e)}`)}},Te=e=>{if(w(e)){const t=Se(e);if(t){const{stack:n,stacktrace:s,"opera#sourceloc":i}=e;switch(t){case n:e.stack=`${n}\n${Ie}`;break;case s:e.stacktrace=`${s}\n${Ie}`;break;default:e["opera#sourceloc"]=`${i}\n${Ie}`}}}globalThis.dispatchEvent(new ErrorEvent("error",{error:e,bubbles:!0,cancelable:!0,composed:!0}))},Ae="RudderLabs JavaScript SDK",we="3.26.0",Ce="RudderJS-Initiated",$e="preloadedEventsBuffer",Pe="ajs_aid",Oe="ajs_event",De=432e5,Re=18e5,Ne=(e="app")=>{globalThis.RudderStackGlobals||(globalThis.RudderStackGlobals={}),globalThis.RudderStackGlobals[e]||(globalThis.RudderStackGlobals[e]={})},Me=(e,t,n="app")=>{Ne(n),globalThis.RudderStackGlobals[n][e]=t},Le=(e,t="app")=>(Ne(t),globalThis.RudderStackGlobals[t][e]);const Be=(e,t)=>{const n={};return e.forEach((s,i)=>{if(i.startsWith(t)){const s=i.substring(t.length);n[s]=e.get(i)}}),n},xe=e=>{const t=Le($e)||[];((e=[])=>{const t="ajs_trait_",n="ajs_prop_",s=new URLSearchParams(globalThis.location.search);s.get(Oe)&&e.unshift(["track",s.get(Oe),Be(s,n)]);const i=s.get("ajs_uid"),r=Be(s,t);if(i||D(r)){const t=[...i?[i]:[],r];e.unshift(["identify",...t])}s.get(Pe)&&e.unshift(["setAnonymousId",s.get(Pe)])})(t),t.length>0&&(e.enqueuePreloadBufferEvents(t),Me($e,[]))},Ue=(e,t)=>{const n=e.shift();let s;if(b(t[n])){switch(n){case"page":s=_(...e);break;case"track":s=H(...e);break;case"identify":s=F(...e);break;case"alias":s=G(...e);break;case"group":s=K(...e);break;default:t[n](...e)}s&&t[n](s)}},je=(e,t,n,s=!0,i)=>new Promise((r,o)=>{document.getElementById(t)&&o(new Error((e=>`A script with the id "${e}" is already loaded. Skipping the loading of this script to prevent conflicts`)(t)));try{let a;(e=>{const t=document.getElementsByTagName("head");if(t.length>0)return void t[0]?.insertBefore(e,t[0]?.firstChild);const n=document.getElementsByTagName("script");if(n.length>0&&n[0]?.parentNode)return void n[0]?.parentNode.insertBefore(e,n[0]);const s=document.createElement("head");s.appendChild(e);const i=document.getElementsByTagName("html")[0];i?.insertBefore(s,i.firstChild)})(((e,t,n=!0,s=null,i=null,r={})=>{const o=document.createElement("script");return o.type="text/javascript",o.onload=s,o.onerror=i,o.src=e,o.id=t,o.async=n,Object.keys(r).forEach(e=>{o.setAttribute(e,r[e])}),o.setAttribute("data-loader","RS_JS_SDK"),o})(e,t,s,()=>{globalThis.clearTimeout(a),r(t)},n=>{globalThis.clearTimeout(a),o(new Error(pe(t,e,n)))},i)),a=globalThis.setTimeout(()=>{o(new Error(((e,t,n)=>`A timeout of ${n} ms occurred while trying to load the script with id "${e}" from URL "${t}"`)(t,e,n)))},n)}catch(n){o(Ee(n,pe(t,e,"unknown")))}});class _e{constructor(e,t=1e4){this.logger=e,this.timeout=t}loadJSFile(e){const{url:t,id:n,timeout:s,async:i,callback:r,extraAttributes:o}=e,a=!b(r);je(t,n,s||this.timeout,i,o).then(e=>{a||r(e)}).catch(e=>{a||r(n,e)})}}var He=Symbol.for("preact-signals");function Fe(){if(Qe>1)Qe--;else{for(var e,t=!1;void 0!==ze;){var n=ze;for(ze=void 0,qe++;void 0!==n;){var s=n.o;if(n.o=void 0,n.f&=-3,!(8&n.f)&&Ye(n))try{n.c()}catch(n){t||(e=n,t=!0)}n=s}}if(qe=0,Qe--,t)throw e}}function Ge(e){if(Qe>0)return e();Qe++;try{return e()}finally{Fe()}}var Ke=void 0;function Ve(e){var t=Ke;Ke=void 0;try{return e()}finally{Ke=t}}var ze=void 0,Qe=0,qe=0,We=0;function Je(e){if(void 0!==Ke){var t=e.n;if(void 0===t||t.t!==Ke)return t={i:0,S:e,p:Ke.s,n:void 0,t:Ke,e:void 0,x:void 0,r:t},void 0!==Ke.s&&(Ke.s.n=t),Ke.s=t,e.n=t,32&Ke.f&&e.S(t),t;if(-1===t.i)return t.i=0,void 0!==t.n&&(t.n.p=t.p,void 0!==t.p&&(t.p.n=t.n),t.p=Ke.s,t.n=void 0,Ke.s.n=t,Ke.s=t),t}}function Xe(e,t){this.v=e,this.i=0,this.n=void 0,this.t=void 0,this.W=null==t?void 0:t.watched,this.Z=null==t?void 0:t.unwatched,this.name=null==t?void 0:t.name}function Ze(e,t){return new Xe(e,t)}function Ye(e){for(var t=e.s;void 0!==t;t=t.n)if(t.S.i!==t.i||!t.S.h()||t.S.i!==t.i)return!0;return!1}function et(e){for(var t=e.s;void 0!==t;t=t.n){var n=t.S.n;if(void 0!==n&&(t.r=n),t.S.n=t,t.i=-1,void 0===t.n){e.s=t;break}}}function tt(e){for(var t=e.s,n=void 0;void 0!==t;){var s=t.p;-1===t.i?(t.S.U(t),void 0!==s&&(s.n=t.n),void 0!==t.n&&(t.n.p=s)):n=t,t.S.n=t.r,void 0!==t.r&&(t.r=void 0),t=s}e.s=n}function nt(e,t){Xe.call(this,void 0),this.x=e,this.s=void 0,this.g=We-1,this.f=4,this.W=null==t?void 0:t.watched,this.Z=null==t?void 0:t.unwatched,this.name=null==t?void 0:t.name}function st(e){var t=e.u;if(e.u=void 0,"function"==typeof t){Qe++;var n=Ke;Ke=void 0;try{t()}catch(t){throw e.f&=-2,e.f|=8,it(e),t}finally{Ke=n,Fe()}}}function it(e){for(var t=e.s;void 0!==t;t=t.n)t.S.U(t);e.x=void 0,e.s=void 0,st(e)}function rt(e){if(Ke!==this)throw new Error("Out-of-order effect");tt(this),Ke=e,this.f&=-2,8&this.f&&it(this),Fe()}function ot(e,t){this.x=e,this.u=void 0,this.s=void 0,this.o=void 0,this.f=32,this.name=null==t?void 0:t.name}function at(e,t){var n=new ot(e,t);try{n.c()}catch(e){throw n.d(),e}var s=n.d.bind(n);return s[Symbol.dispose]=s,s}Xe.prototype.brand=He,Xe.prototype.h=function(){return!0},Xe.prototype.S=function(e){var t=this,n=this.t;n!==e&&void 0===e.e&&(e.x=n,this.t=e,void 0!==n?n.e=e:Ve(function(){var e;null==(e=t.W)||e.call(t)}))},Xe.prototype.U=function(e){var t=this;if(void 0!==this.t){var n=e.e,s=e.x;void 0!==n&&(n.x=s,e.e=void 0),void 0!==s&&(s.e=n,e.x=void 0),e===this.t&&(this.t=s,void 0===s&&Ve(function(){var e;null==(e=t.Z)||e.call(t)}))}},Xe.prototype.subscribe=function(e){var t=this;return at(function(){var n=t.value,s=Ke;Ke=void 0;try{e(n)}finally{Ke=s}},{name:"sub"})},Xe.prototype.valueOf=function(){return this.value},Xe.prototype.toString=function(){return this.value+""},Xe.prototype.toJSON=function(){return this.value},Xe.prototype.peek=function(){var e=Ke;Ke=void 0;try{return this.value}finally{Ke=e}},Object.defineProperty(Xe.prototype,"value",{get:function(){var e=Je(this);return void 0!==e&&(e.i=this.i),this.v},set:function(e){if(e!==this.v){if(qe>100)throw new Error("Cycle detected");this.v=e,this.i++,We++,Qe++;try{for(var t=this.t;void 0!==t;t=t.x)t.t.N()}finally{Fe()}}}}),nt.prototype=new Xe,nt.prototype.h=function(){if(this.f&=-3,1&this.f)return!1;if(32==(36&this.f))return!0;if(this.f&=-5,this.g===We)return!0;if(this.g=We,this.f|=1,this.i>0&&!Ye(this))return this.f&=-2,!0;var e=Ke;try{et(this),Ke=this;var t=this.x();(16&this.f||this.v!==t||0===this.i)&&(this.v=t,this.f&=-17,this.i++)}catch(e){this.v=e,this.f|=16,this.i++}return Ke=e,tt(this),this.f&=-2,!0},nt.prototype.S=function(e){if(void 0===this.t){this.f|=36;for(var t=this.s;void 0!==t;t=t.n)t.S.S(t)}Xe.prototype.S.call(this,e)},nt.prototype.U=function(e){if(void 0!==this.t&&(Xe.prototype.U.call(this,e),void 0===this.t)){this.f&=-33;for(var t=this.s;void 0!==t;t=t.n)t.S.U(t)}},nt.prototype.N=function(){if(!(2&this.f)){this.f|=6;for(var e=this.t;void 0!==e;e=e.x)e.t.N()}},Object.defineProperty(nt.prototype,"value",{get:function(){if(1&this.f)throw new Error("Cycle detected");var e=Je(this);if(this.h(),void 0!==e&&(e.i=this.i),16&this.f)throw this.v;return this.v}}),ot.prototype.c=function(){var e=this.S();try{if(8&this.f)return;if(void 0===this.x)return;var t=this.x();"function"==typeof t&&(this.u=t)}finally{e()}},ot.prototype.S=function(){if(1&this.f)throw new Error("Cycle detected");this.f|=1,this.f&=-9,st(this),et(this),Qe++;var e=Ke;return Ke=this,rt.bind(this,e)},ot.prototype.N=function(){2&this.f||(this.f|=2,this.o=ze,ze=this)},ot.prototype.d=function(){this.f|=8,1&this.f||it(this)},ot.prototype.dispose=function(){this.d()};class lt{constructor(){this.items=[]}enqueue(e){this.items.push(e)}dequeue(){return 0===this.items.length?null:this.items.shift()}isEmpty(){return 0===this.items.length}size(){return this.items.length}clear(){this.items=[]}}const ut={LOG:0,INFO:1,DEBUG:2,WARN:3,ERROR:4,NONE:5},ct="ERROR";const dt=new class{constructor(e="LOG",t="",n=console){this.minLogLevel=ut[e],this.scope=t,this.logProvider=n}log(...e){this.outputLog("LOG",e)}info(...e){this.outputLog("INFO",e)}debug(...e){this.outputLog("DEBUG",e)}warn(...e){this.outputLog("WARN",e)}error(...e){this.outputLog("ERROR",e)}outputLog(e,t){this.minLogLevel<=ut[e]&&this.logProvider[e.toLowerCase()]?.(...this.formatLogData(t))}setScope(e){this.scope=e||this.scope}setMinLogLevel(e){this.minLogLevel=ut[e],S(this.minLogLevel)&&(this.minLogLevel=ut.LOG)}formatLogData(e){if(Array.isArray(e)&&e.length>0){let t="%c RS SDK";this.scope&&(t=`${t} - ${this.scope}`);t=`${t} %c ${k(e[0])?e[0].trim():""}`;const n=[t,"font-weight: bold; background: black; color: white;","font-weight: normal;"];return k(e[0])||n.push(e[0]),n.push(...e.slice(1)),n}return e}};let gt=function(e){return e.HANDLEDEXCEPTION="handledException",e.UNHANDLEDEXCEPTION="unhandledException",e.UNHANDLEDREJECTION="unhandledPromiseRejection",e}({});const ht=["localStorage","memoryStorage","cookieStorage","sessionStorage","none"],pt="cookieStorage",vt="Unable to process/parse source configuration response",ft="Failed to log breadcrumb",yt="Failed to fetch the source config",mt=e=>`${e}${he}The provided callback parameter is not a function.`,bt=(e,t,n)=>`${e} due to timeout or no connection (${t?t.type:""}) at the client side for URL: ${n}`,kt="Failed to set/remove cookies via server. As a fallback, the cookies will be managed client side.",It={All:!0},St="js-integrations",Et="plugins",Tt=new RegExp("^(https?:\\/\\/)(((([a-zA-Z\\d]([a-zA-Z\\d-]*[a-zA-Z\\d])*)\\.)+[a-zA-Z]{2,}|localhost|((25[0-5]|2[0-4][0-9]|[0-1]?[0-9]?[0-9]?)\\.){3}(25[0-5]|2[0-4][0-9]|[0-1]?[0-9]?[0-9]?)))(\\:\\d+)?(\\/[-a-zA-Z\\d%_.~+]*)*(\\?[;&a-zA-Z\\d%_.~+=-]*)?(\\#[-a-zA-Z\\d_]*)?$"),At="modern",wt="https://cdn.rudderlabs.com",Ct="v3",$t=`${wt}/${Ct}/${At}/${St}`,Pt=`${wt}/${Ct}/${At}/${Et}`,Ot="https://api.rudderstack.com",Dt="v3",Rt="xhr",Nt={iubenda:"IubendaConsentManager",oneTrust:"OneTrustConsentManager",ketch:"KetchConsentManager",custom:"CustomConsentManager"},Mt={[Dt]:"StorageEncryption",legacy:"StorageEncryptionLegacy"},Lt={[Rt]:"XhrQueue",beacon:"BeaconQueue"},Bt=Ze(g({configUrl:Ot,loadIntegration:!0,sessions:{autoTrack:!0,timeout:Re,cutOff:{enabled:!1}},sameSiteCookie:"Lax",polyfillIfRequired:!0,integrations:It,useBeacon:!1,beaconQueueOptions:{},destinationsQueueOptions:{},queueOptions:{},lockIntegrationsVersion:!0,lockPluginsVersion:!0,uaChTrackLevel:"none",plugins:[],useGlobalIntegrationsConfigInEvents:!1,bufferDataPlaneEventsUntilReady:!1,dataPlaneEventsBufferTimeout:1e4,storage:{encryption:{version:Dt},migrate:!0,cookie:{}},sendAdblockPage:!1,sameDomainCookiesOnly:!1,secureCookie:!1,sendAdblockPageOptions:{},useServerSideCookies:!1})),xt=B({userId:"",userTraits:{},anonymousId:"",groupId:"",groupTraits:{},initialReferrer:"",initialReferringDomain:"",sessionInfo:{},authToken:null}),Ut=B({entries:{userId:!0,userTraits:!0,groupId:!0,groupTraits:!0,sessionInfo:!0,authToken:!0,anonymousId:!1,initialReferrer:!1,initialReferringDomain:!1}}),jt={userId:Ze(xt.userId),userTraits:Ze(xt.userTraits),anonymousId:Ze(xt.anonymousId),groupId:Ze(xt.groupId),groupTraits:Ze(xt.groupTraits),initialReferrer:Ze(xt.initialReferrer),initialReferringDomain:Ze(xt.initialReferringDomain),sessionInfo:Ze(xt.sessionInfo),authToken:Ze(xt.authToken)},_t={isOnline:Ze(!0),storage:{isLocalStorageAvailable:Ze(!1),isCookieStorageAvailable:Ze(!1),isSessionStorageAvailable:Ze(!1)},isBeaconAvailable:Ze(!1),isLegacyDOM:Ze(!1),isUaCHAvailable:Ze(!1),isCryptoAvailable:Ze(!1),isIE11:Ze(!1),isAdBlockerDetectionInProgress:Ze(!1),isAdBlocked:Ze(void 0),cspBlockedURLs:Ze([])},Ht={isErrorReportingEnabled:Ze(!1),isMetricsReportingEnabled:Ze(!1),breadcrumbs:Ze([])},Ft=Ze(void 0),Gt={activeDataplaneUrl:Ze(void 0),integrationsCDNPath:Ze($t),pluginsCDNPath:Ze(Pt),sourceConfigUrl:Ze(void 0),status:Ze(void 0),initialized:Ze(!1),logLevel:Ze(ct),loaded:Ze(!1),readyCallbacks:Ze([]),writeKey:Ze(void 0),dataPlaneUrl:Ze(void 0),safeAnalyticsInstance:Ze(void 0)},Kt={enabled:Ze(!1),initialized:Ze(!1),data:Ze({}),activeConsentManagerPluginName:Ze(void 0),preConsent:Ze({enabled:!1}),postConsent:Ze({}),resolutionStrategy:Ze("and"),provider:Ze(void 0),metadata:Ze(void 0)},Vt={retries:Ze(0),dropped:Ze(0),sent:Ze(0),queued:Ze(0),triggered:Ze(0),metricsServiceUrl:Ze(void 0)},zt={app:Ze({name:Ae,namespace:"com.rudderlabs.javascript",version:we,installType:"cdn"}),traits:Ze(null),library:Ze({name:Ae,version:we,snippetVersion:globalThis.RudderSnippetVersion}),userAgent:Ze(null),device:Ze(null),network:Ze(null),os:Ze({name:"",version:""}),locale:Ze(null),screen:Ze({density:0,width:0,height:0,innerWidth:0,innerHeight:0}),"ua-ch":Ze(void 0),timezone:Ze(void 0)},Qt={configuredDestinations:Ze([]),activeDestinations:Ze([]),loadOnlyIntegrations:Ze({}),failedDestinations:Ze([]),loadIntegration:Ze(!0),initializedDestinations:Ze([]),clientDestinationsReady:Ze(!1),integrationsConfig:Ze({})},qt={toBeProcessedArray:Ze([]),readyCallbacksArray:Ze([])},Wt={ready:Ze(!1),loadedPlugins:Ze([]),failedPlugins:Ze([]),pluginsToLoadFromConfig:Ze([]),activePlugins:Ze([]),totalPluginsToLoad:Ze(0)},Jt={encryptionPluginName:Ze(void 0),migrate:Ze(!1),type:Ze(void 0),cookie:Ze(void 0),entries:Ze({}),trulyAnonymousTracking:Ze(!1)},Xt={isEnabledServerSideCookies:Ze(!1),dataServiceUrl:Ze(void 0)},Zt={eventsQueuePluginName:Ze(void 0),deliveryEnabled:Ze(!0)},Yt={enabled:Ze(!1),pageLifecycle:{enabled:Ze(!1),pageViewId:Ze(void 0),pageLoadedTimestamp:Ze(void 0)}},en={...g({capabilities:_t,consents:Kt,context:zt,eventBuffer:qt,lifecycle:Gt,loadOptions:Bt,metrics:Vt,nativeDestinations:Qt,plugins:Wt,reporting:Ht,session:jt,source:Ft,storage:Jt,serverCookies:Xt,dataPlaneEvents:Zt,autoTrack:Yt})};function tn(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var nn,sn={exports:{}},rn={exports:{}};function on(){return nn||(nn=1,rn.exports=function(){function e(e){return!isNaN(parseFloat(e))&&isFinite(e)}function t(e){return e.charAt(0).toUpperCase()+e.substring(1)}function n(e){return function(){return this[e]}}var s=["isConstructor","isEval","isNative","isToplevel"],i=["columnNumber","lineNumber"],r=["fileName","functionName","source"],o=["args"],a=["evalOrigin"],l=s.concat(i,r,o,a);function u(e){if(e)for(var n=0;n<l.length;n++)void 0!==e[l[n]]&&this["set"+t(l[n])](e[l[n]])}u.prototype={getArgs:function(){return this.args},setArgs:function(e){if("[object Array]"!==Object.prototype.toString.call(e))throw new TypeError("Args must be an Array");this.args=e},getEvalOrigin:function(){return this.evalOrigin},setEvalOrigin:function(e){if(e instanceof u)this.evalOrigin=e;else{if(!(e instanceof Object))throw new TypeError("Eval Origin must be an Object or StackFrame");this.evalOrigin=new u(e)}},toString:function(){var e=this.getFileName()||"",t=this.getLineNumber()||"",n=this.getColumnNumber()||"",s=this.getFunctionName()||"";return this.getIsEval()?e?"[eval] ("+e+":"+t+":"+n+")":"[eval]:"+t+":"+n:s?s+" ("+e+":"+t+":"+n+")":e+":"+t+":"+n}},u.fromString=function(e){var t=e.indexOf("("),n=e.lastIndexOf(")"),s=e.substring(0,t),i=e.substring(t+1,n).split(","),r=e.substring(n+1);if(0===r.indexOf("@"))var o=/@(.+?)(?::(\d+))?(?::(\d+))?$/.exec(r,""),a=o[1],l=o[2],c=o[3];return new u({functionName:s,args:i||void 0,fileName:a,lineNumber:l||void 0,columnNumber:c||void 0})};for(var c=0;c<s.length;c++)u.prototype["get"+t(s[c])]=n(s[c]),u.prototype["set"+t(s[c])]=function(e){return function(t){this[e]=Boolean(t)}}(s[c]);for(var d=0;d<i.length;d++)u.prototype["get"+t(i[d])]=n(i[d]),u.prototype["set"+t(i[d])]=function(t){return function(n){if(!e(n))throw new TypeError(t+" must be a Number");this[t]=Number(n)}}(i[d]);for(var g=0;g<r.length;g++)u.prototype["get"+t(r[g])]=n(r[g]),u.prototype["set"+t(r[g])]=function(e){return function(t){this[e]=String(t)}}(r[g]);return u}()),rn.exports}var an;var ln,un,cn,dn,gn=(an||(an=1,sn.exports=(ln=on(),un=/(^|@)\S+:\d+/,cn=/^\s*at .*(\S+:\d+|\(native\))/m,dn=/^(eval@)?(\[native code])?$/,{parse:function(e){if(void 0!==e.stacktrace||void 0!==e["opera#sourceloc"])return this.parseOpera(e);if(e.stack&&e.stack.match(cn))return this.parseV8OrIE(e);if(e.stack)return this.parseFFOrSafari(e);throw new Error("Cannot parse given Error object")},extractLocation:function(e){if(-1===e.indexOf(":"))return[e];var t=/(.+?)(?::(\d+))?(?::(\d+))?$/.exec(e.replace(/[()]/g,""));return[t[1],t[2]||void 0,t[3]||void 0]},parseV8OrIE:function(e){return e.stack.split("\n").filter(function(e){return!!e.match(cn)},this).map(function(e){e.indexOf("(eval ")>-1&&(e=e.replace(/eval code/g,"eval").replace(/(\(eval at [^()]*)|(,.*$)/g,""));var t=e.replace(/^\s+/,"").replace(/\(eval code/g,"(").replace(/^.*?\s+/,""),n=t.match(/ (\(.+\)$)/);t=n?t.replace(n[0],""):t;var s=this.extractLocation(n?n[1]:t),i=n&&t||void 0,r=["eval","<anonymous>"].indexOf(s[0])>-1?void 0:s[0];return new ln({functionName:i,fileName:r,lineNumber:s[1],columnNumber:s[2],source:e})},this)},parseFFOrSafari:function(e){return e.stack.split("\n").filter(function(e){return!e.match(dn)},this).map(function(e){if(e.indexOf(" > eval")>-1&&(e=e.replace(/ line (\d+)(?: > eval line \d+)* > eval:\d+:\d+/g,":$1")),-1===e.indexOf("@")&&-1===e.indexOf(":"))return new ln({functionName:e});var t=/((.*".+"[^@]*)?[^@]*)(?:@)/,n=e.match(t),s=n&&n[1]?n[1]:void 0,i=this.extractLocation(e.replace(t,""));return new ln({functionName:s,fileName:i[0],lineNumber:i[1],columnNumber:i[2],source:e})},this)},parseOpera:function(e){return!e.stacktrace||e.message.indexOf("\n")>-1&&e.message.split("\n").length>e.stacktrace.split("\n").length?this.parseOpera9(e):e.stack?this.parseOpera11(e):this.parseOpera10(e)},parseOpera9:function(e){for(var t=/Line (\d+).*script (?:in )?(\S+)/i,n=e.message.split("\n"),s=[],i=2,r=n.length;i<r;i+=2){var o=t.exec(n[i]);o&&s.push(new ln({fileName:o[2],lineNumber:o[1],source:n[i]}))}return s},parseOpera10:function(e){for(var t=/Line (\d+).*script (?:in )?(\S+)(?:: In function (\S+))?$/i,n=e.stacktrace.split("\n"),s=[],i=0,r=n.length;i<r;i+=2){var o=t.exec(n[i]);o&&s.push(new ln({functionName:o[3]||void 0,fileName:o[2],lineNumber:o[1],source:n[i]}))}return s},parseOpera11:function(e){return e.stack.split("\n").filter(function(e){return!!e.match(un)&&!e.match(/^Error created at/)},this).map(function(e){var t,n=e.split("@"),s=this.extractLocation(n.pop()),i=n.shift()||"",r=i.replace(/<anonymous function(: (\w+))?>/,"$2").replace(/\([^)]*\)/g,"")||void 0;i.match(/\(([^)]*)\)/)&&(t=i.replace(/^[^(]+\(([^)]*)\)$/,"$1"));var o=void 0===t||"[arguments not available]"===t?void 0:t.split(",");return new ln({functionName:r,args:o,fileName:s[0],lineNumber:s[1],columnNumber:s[2],source:e})},this)}})),sn.exports);const hn=tn(gn),pn="global code",vn=e=>k(e)?e:"";function fn(e,t,n,s){return{errorClass:vn(e),message:`${n}${vn(t)}`,type:"browserjs",stacktrace:s.reduce((e,t)=>{const n=(e=>{const t={file:e.fileName,method:(n=e.functionName,T(n)&&/^global code$/i.test(n)?pn:n),lineNumber:e.lineNumber,columnNumber:e.columnNumber};var n;return t.lineNumber&&t.lineNumber>-1&&!t.file&&!t.method&&(t.file=pn),t})(t);try{return"{}"===JSON.stringify(n)?e:e.concat(n)}catch{return e}},[])}}const yn=(e,t)=>{let n;var s,i;return w(e)&&k(Se(e))?n=e:(t.warn((s=Z,i=ye(e),`${s}${he}Ignoring a non-error: ${i}.`)),n=void 0),n},mn=(e,t)=>{try{return JSON.parse(e||"")}catch(e){t(Ee(e,"Failed to parse response data"))}},bn="The request failed",kn=[new RegExp(`${bn}.*`),/A script with the id .* is already loaded\./],In=[/Failed to fetch dynamically imported module: .*/,/Unable to load \(.*\) the script with the id .*/,/A timeout of \d+ ms occurred while trying to load the script with id .*/],Sn={headers:{Accept:"application/json","Content-Type":"application/json;charset=UTF-8"},method:"GET"},En=(e,t,n)=>{const s=O(Sn,t||{});return n&&(s.headers=O(s.headers,{Authorization:n})),s.url=e,s},Tn=(e,t=1e4,n)=>new Promise((s,i)=>{let r;if(!0===e.sendRawData)r=e.data;else if(r=ye(e.data,!1,[],n),I(r))return void i({error:new Error("Failed to prepare data for the request."),undefined:void 0,options:e});const o=new XMLHttpRequest,a=t=>{i({error:new Error(bt(bn,t,e.url)),xhr:o,options:e,..."timeout"===t?.type?{timedOut:!0}:{}})};o.ontimeout=a,o.onerror=a,o.onload=()=>{var t,n,r,a,l;o.status>=200&&o.status<400?s({response:o.responseText,xhr:o,options:e}):i({error:new Error((t=bn,n=o.status,r=o.statusText,a=e.url,l=o.responseText,`${t} with status ${n} (${r}) for URL: ${a}. Response: ${l.trim()}`)),xhr:o,options:e})},o.open(e.method,e.url,!0),!0===e.withCredentials&&(o.withCredentials=!0),o.timeout=t,Object.keys(e.headers).forEach(t=>{e.headers[t]&&o.setRequestHeader(t,e.headers[t])});try{o.send(r)}catch(t){i({error:Ee(t,(l=bn,u=e.url,`${l} for URL: ${u}`)),xhr:o,options:e})}var l,u});const An=new class{constructor(e){this.logger=e,this.onError=this.onError.bind(this)}init(e){this.errorHandler=e}async getData(e){const{url:t,options:n,timeout:s,isRawResponse:i}=e;try{const e=await Tn(En(t,n,this.basicAuthHeader),s,this.logger);return{data:i?e.response:mn(e.response,this.onError),details:e}}catch(e){return{data:void 0,details:e}}}getAsyncData(e){const{callback:t,url:n,options:s,timeout:i,isRawResponse:r}=e,o=!b(t);Tn(En(n,s,this.basicAuthHeader),i,this.logger).then(e=>{o||t(r?e.response:mn(e.response,this.onError),e)}).catch(e=>{o||t(void 0,e)})}onError(e,t){this.errorHandler?.onError({error:e,context:"HttpClient",groupingHash:t})}setAuthHeader(e,t=!1){const n=t?e:j(`${e}:`);this.basicAuthHeader=`Basic ${n}`}resetAuthHeader(){this.basicAuthHeader=void 0}}(dt),wn=["www.test-host.com","localhost","127.0.0.1","[::1]"],Cn=["userId","userTraits","groupId","groupTraits","anonymousId","config","integration","eventBuffer","traits","authToken"],$n=e=>{en.capabilities.isAdBlockerDetectionInProgress.value=!0;try{const t=new URL(en.lifecycle.sourceConfigUrl.value),n=`${t.origin}${t.pathname}?view=ad`;e.getAsyncData({url:n,options:{method:"HEAD",headers:{"Content-Type":void 0}},isRawResponse:!0,callback:(e,t)=>{en.capabilities.isAdBlockerDetectionInProgress.value=!1,en.capabilities.isAdBlocked.value=void 0!==t?.error||t?.xhr?.responseURL!==n}})}catch(e){throw en.capabilities.isAdBlockerDetectionInProgress.value=!1,e}},Pn=(e=()=>window.location.hostname)=>{const t=e();return!t||t&&wn.includes(t)?"development":"production"},On=e=>{const t=ye(e,!1,Cn);return null!==t?JSON.parse(t):{}},Dn=(e,t,n,s)=>({id:`${e.value?.id??n.writeKey.value}..${t.sessionInfo.value.id??"NA"}..${s.pageLifecycle.pageViewId.value??"NA"}`,name:e.value?.name??"NA"}),Rn=(e,t)=>({locale:e.value??"NA",userAgent:t.value??"NA",time:new Date}),Nn=(e,t,n)=>{const s=e.message;return new Promise(e=>{if(In.some(e=>e.test(s))){const i=/https?:\/\/[^\s"'(),;<>[\]{}]+/.exec(s)?.[0];k(i)?i.startsWith(wt)?t.capabilities.cspBlockedURLs.value.includes(i)?e(!1):((e,t,n)=>{if(S(e.capabilities.isAdBlocked.value)){!1===e.capabilities.isAdBlockerDetectionInProgress.value&&$n(t);const s=at(()=>{T(e.capabilities.isAdBlocked.value)&&(n(!1===e.capabilities.isAdBlocked.value),s())})}else n(!1===e.capabilities.isAdBlocked.value)})(t,n,e):e(!1):e(!0)}else e(!kn.some(e=>e.test(s)))})},Mn=(e,t,n)=>{const s={version:"1",message_id:ce(),source:{name:"js",sdk_version:t.context.app.value.version,write_key:t.lifecycle.writeKey.value,install_type:t.context.app.value.installType,category:n??"sdk"},errors:e};return ye(s)};const Ln=new class{initialized=!1;constructor(e,t){this.httpClient=e,this.logger=t}init(){this.initialized||(this.attachErrorListeners(),this.initialized=!0)}attachErrorListeners(){globalThis.addEventListener("error",e=>{this.onError({error:e,context:Z,errorType:gt.UNHANDLEDEXCEPTION})}),globalThis.addEventListener("unhandledrejection",e=>{this.onError({error:e,context:Z,errorType:gt.UNHANDLEDREJECTION})}),document.addEventListener("securitypolicyviolation",e=>{const t=k(e.blockedURI)?e.blockedURI:"";"enforce"===e.disposition&&t.startsWith(wt)&&!en.capabilities.cspBlockedURLs.value.includes(t)&&(en.capabilities.cspBlockedURLs.value=[...en.capabilities.cspBlockedURLs.value,t])})}async onError(e){try{const{error:t,context:n,customMessage:s,groupingHash:i,category:r}=e,o=e.errorType??gt.HANDLEDEXCEPTION,a=((e,t)=>{switch(t){case gt.UNHANDLEDEXCEPTION:{const{error:t}=e;return t||e}case gt.UNHANDLEDREJECTION:return e.reason;case gt.HANDLEDEXCEPTION:default:return e}})(t,o),l=yn(a,this.logger);if(S(l))return;const u=s?`${s} - `:"",c=((e,t)=>{try{const n=hn.parse(e);return fn(e.name,e.message,t,n)}catch{return fn(e.name,e.message,t,[])}})(l,`${n}${he}${u}`),d=Se(l).includes(Ie);if(!d&&!(e=>{const t=e.stacktrace[0]?.file;if(!t||"string"!=typeof t)return!1;const n=t.substring(t.lastIndexOf("/")+1),s=t.split("/");return s[s.length-2]===St||["rsa"].some(e=>n.startsWith(e)&&n.endsWith(".js"))})(c)&&o!==gt.HANDLEDEXCEPTION)return;if(en.reporting.isErrorReportingEnabled.value){if(await Nn(c,en,this.httpClient)){const e={severity:"error",unhandled:o!==gt.HANDLEDEXCEPTION,severityReason:{type:o}},t=((e,t,n,s)=>{let i;if("cdn"!==n.context.app.value.installType)return i;if(T(e))if(k(e))i=e;else{const n=yn(e,s);i=T(n)?n.message:t}else i=t;return i})(i,c.message,en,this.logger),n=((e,t,n,s)=>{const{context:i,lifecycle:r,session:o,source:a,reporting:l,autoTrack:u}=n,{app:c,locale:d,userAgent:h,timezone:p,screen:v,library:f}=i;return{payloadVersion:"5",notifier:{name:"RudderStack JavaScript SDK",version:c.value.version,url:"git+https://github.com/rudderlabs/rudder-sdk-js.git"},events:[{exceptions:[g(e)],severity:t.severity,unhandled:t.unhandled,severityReason:t.severityReason,app:{version:c.value.version,releaseStage:Pn(),type:c.value.installType},device:Rn(d,h),request:{url:globalThis.location.href.split("?")[0],clientIp:"[NOT COLLECTED]"},breadcrumbs:g(l.breadcrumbs.value),context:e.message,groupingHash:s,metaData:{app:{snippetVersion:f.value.snippetVersion},device:{...v.value,timezone:p.value},...On(n)},user:Dn(a,o,r,u)}]}})(c,e,en,t);this.httpClient.getAsyncData({url:en.metrics.metricsServiceUrl.value,options:{method:"POST",data:Mn(n,en,r),sendRawData:!0},isRawResponse:!0})}}(o===gt.HANDLEDEXCEPTION||d)&&this.logger.error(c.message)}catch(e){this.logger.error(`${Z}${he}Failed to handle the error.`,e)}}leaveBreadcrumb(e){try{en.reporting.breadcrumbs.value=[...en.reporting.breadcrumbs.value,(t=e,{type:"manual",name:t,timestamp:new Date,metaData:{}})]}catch(e){this.onError({error:e,context:Z,customMessage:ft,groupingHash:ft})}var t}}(An,dt);const Bn=new class{plugins=[];byName={};cache={};config={throws:!0};constructor(e,t={}){this.config={throws:!0,...t},this.logger=e}register(e,t){if(!e.name){const t=`${Y}${he}Plugin name is missing.`;if(this.config.throws)throw new Error(t);return void this.logger.error(t,e)}if(this.byName[e.name]){const t=((e,t)=>`${e}${he}Plugin "${t}" already exists.`)(Y,e.name);if(this.config.throws)throw new Error(t);return void this.logger.error(t)}this.cache={},this.plugins=this.plugins.slice();let n=this.plugins.length;this.plugins.forEach((t,s)=>{t.deps?.includes(e.name)&&(n=Math.min(n,s))}),this.plugins.splice(n,0,e),this.byName[e.name]=e,b(e.initialize)&&e.initialize(t)}unregister(e){const t=this.byName[e];if(!t){const t=`${Y}${he}Plugin "${e}" not found.`;if(this.config.throws)throw new Error(t);return void this.logger.error(t)}const n=this.plugins.indexOf(t);if(-1===n){const t=((e,t)=>`${e}${he}Plugin "${t}" not found in plugins but found in byName. This indicates a bug in the plugin engine. Please report this issue to the development team.`)(Y,e);if(this.config.throws)throw new Error(t);return void this.logger.error(t)}this.cache={},delete this.byName[e],this.plugins=this.plugins.slice(),this.plugins.splice(n,1)}getPlugin(e){return this.byName[e]}getPlugins(e){const t=e??".";return this.cache[t]||(this.cache[t]=this.plugins.filter(e=>{if(e.deps?.some(e=>!this.byName[e])){const t=e.deps.filter(e=>!this.byName[e]);return this.logger.error(((e,t,n)=>`${e}${he}Plugin "${t}" could not be loaded because some of its dependencies "${n}" do not exist.`)(Y,e.name,t)),!1}return"."===t||((e,t)=>Boolean(C(e,t)))(e,t)})),this.cache[t]}processRawPlugins(e){e(this.plugins),this.cache={}}invoke(e,t=!0,...n){let s=e;if(!s)throw new Error("Failed to invoke plugin because the extension point name is missing.");const i=s.startsWith("!"),r=this.config.throws??s.endsWith("!");if(s=s.replace(/(^!|!$)/g,""),!s)throw new Error("Failed to invoke plugin because the extension point name is invalid.");const o=s.split(".");o.pop();const a=o.join(".");return(t?this.getPlugins(s):[this.getPlugins(s)[0]]).map(e=>{const t=C(e,s);if(!b(t)||i)return t;try{return t.apply(C(e,a),n)}catch(t){if(r)throw t;this.logger.error(((e,t,n)=>`${e}${he}Failed to invoke the "${t}" extension point of plugin "${n}".`)(Y,s,e.name),t)}return null})}invokeSingle(e,...t){return this.invoke(e,!1,...t)[0]}invokeMultiple(e,...t){return this.invoke(e,!0,...t)}}(dt,{throws:!0}),xn=e=>Boolean("cloud"!==e.config.connectionMode||!0===e.config.useNativeSDKToSend||!0===e.config.useNativeSDK),Un=e=>e.filter(xn),jn=["BeaconQueue","CustomConsentManager","DeviceModeDestinations","DeviceModeTransformation","ExternalAnonymousId","GoogleLinker","IubendaConsentManager","KetchConsentManager","NativeDestinationQueue","OneTrustConsentManager","StorageEncryption","StorageEncryptionLegacy","StorageMigrator","XhrQueue"],_n=["Bugsnag","ErrorReporting"],Hn={rudderAnalyticsRemotePlugins:{url:()=>Promise.resolve(window.RudderStackGlobals&&window.RudderStackGlobals.app&&window.RudderStackGlobals.app.pluginsCDNPath?`${window.RudderStackGlobals.app.pluginsCDNPath}/rsa-plugins.js`:"https://cdn.rudderlabs.com/v3//rsa-plugins.js"),format:"esm",from:"vite"}};function Fn(e,t){const n=Object.assign(e,t);for(const e of Object.keys(n))"object"==typeof n[e]&&"object"==typeof t[e]&&(n[e]=Fn(n[e],t[e]));return n}const Gn=e=>Fn({},(globalThis.__federation_shared__||{}).default||{});function Kn(e,t){if(!e?.default&&t){let t=Object.create(null);return t.default=e,t.__esModule=!0,t}return e}function Vn(e,t){return async function(e){const t=Hn[e];return t.inited?t.lib:["esm","systemjs"].includes(t.format)?new Promise((e,n)=>{("function"==typeof t.url?t.url:()=>Promise.resolve(t.url))().then(s=>{import(s).then(n=>{if(!t.inited){const e=Gn();n.init(e),t.lib=n,t.lib.init(e),t.inited=!0}e(t.lib)}).catch(n)})}):void 0}(e).then(e=>e.get(t).then(e=>e()))}const zn=e=>{const t={};return e.forEach(e=>{if(jn.includes(e)){const n=(e=>{switch(e){case"BeaconQueue":return()=>Vn("rudderAnalyticsRemotePlugins","./BeaconQueue").then(e=>Kn(e,!0));case"CustomConsentManager":return()=>Vn("rudderAnalyticsRemotePlugins","./CustomConsentManager").then(e=>Kn(e,!0));case"DeviceModeDestinations":return()=>Vn("rudderAnalyticsRemotePlugins","./DeviceModeDestinations").then(e=>Kn(e,!0));case"DeviceModeTransformation":return()=>Vn("rudderAnalyticsRemotePlugins","./DeviceModeTransformation").then(e=>Kn(e,!0));case"ExternalAnonymousId":return()=>Vn("rudderAnalyticsRemotePlugins","./ExternalAnonymousId").then(e=>Kn(e,!0));case"GoogleLinker":return()=>Vn("rudderAnalyticsRemotePlugins","./GoogleLinker").then(e=>Kn(e,!0));case"KetchConsentManager":return()=>Vn("rudderAnalyticsRemotePlugins","./KetchConsentManager").then(e=>Kn(e,!0));case"IubendaConsentManager":return()=>Vn("rudderAnalyticsRemotePlugins","./IubendaConsentManager").then(e=>Kn(e,!0));case"NativeDestinationQueue":return()=>Vn("rudderAnalyticsRemotePlugins","./NativeDestinationQueue").then(e=>Kn(e,!0));case"OneTrustConsentManager":return()=>Vn("rudderAnalyticsRemotePlugins","./OneTrustConsentManager").then(e=>Kn(e,!0));case"StorageEncryption":return()=>Vn("rudderAnalyticsRemotePlugins","./StorageEncryption").then(e=>Kn(e,!0));case"StorageEncryptionLegacy":return()=>Vn("rudderAnalyticsRemotePlugins","./StorageEncryptionLegacy").then(e=>Kn(e,!0));case"StorageMigrator":return()=>Vn("rudderAnalyticsRemotePlugins","./StorageMigrator").then(e=>Kn(e,!0));case"XhrQueue":return()=>Vn("rudderAnalyticsRemotePlugins","./XhrQueue").then(e=>Kn(e,!0));default:return}})(e);n&&(t[e]=n)}}),t},Qn=e=>zn?.(e)||{},qn={};class Wn{constructor(e,t,n){this.engine=e,this.errorHandler=t,this.logger=n,this.onError=this.onError.bind(this)}init(){en.lifecycle.status.value="pluginsLoading",Me("pluginsCDNPath",en.lifecycle.pluginsCDNPath.value),this.setActivePlugins(),this.registerLocalPlugins(),this.registerRemotePlugins(),this.attachEffects()}attachEffects(){at(()=>{(0===en.plugins.activePlugins.value.length||en.plugins.loadedPlugins.value.length+en.plugins.failedPlugins.value.length===en.plugins.totalPluginsToLoad.value)&&Ge(()=>{en.plugins.ready.value=!0,en.lifecycle.status.value="pluginsReady"})})}getPluginsToLoadBasedOnConfig(){let e=en.plugins.pluginsToLoadFromConfig.value;if(!e)return[];e=e.filter(e=>!_n.includes(e)||(this.logger.warn(((e,t)=>`${e}${he}${t} plugin is deprecated. Please exclude it from the load API options.`)(J,e)),!1));const t=[{configurationStatus:()=>T(en.dataPlaneEvents.eventsQueuePluginName.value),configurationStatusStr:"Data plane events delivery is enabled",activePluginName:en.dataPlaneEvents.eventsQueuePluginName.value,supportedPlugins:Object.values(Lt),shouldAddMissingPlugins:!0},{configurationStatus:()=>Un(en.nativeDestinations.configuredDestinations.value).length>0,configurationStatusStr:"Device mode destinations are connected to the source",supportedPlugins:["DeviceModeDestinations","NativeDestinationQueue"]},{configurationStatus:()=>Un(en.nativeDestinations.configuredDestinations.value).some(e=>e.shouldApplyDeviceModeTransformation),configurationStatusStr:"Device mode transformations are enabled for at least one destination",supportedPlugins:["DeviceModeTransformation"]},{configurationStatus:()=>T(en.consents.activeConsentManagerPluginName.value),configurationStatusStr:"Consent management is enabled",activePluginName:en.consents.activeConsentManagerPluginName.value,supportedPlugins:Object.values(Nt)},{configurationStatus:()=>T(en.storage.encryptionPluginName.value),configurationStatusStr:"Storage encryption is enabled",activePluginName:en.storage.encryptionPluginName.value,supportedPlugins:Object.values(Mt)},{configurationStatus:()=>en.storage.migrate.value,configurationStatusStr:"Storage migration is enabled",supportedPlugins:["StorageMigrator"]}];return t.forEach(t=>{t.configurationStatus()?(e=e.filter(t.activePluginName?e=>!(e!==t.activePluginName&&t.supportedPlugins.includes(e)):e=>T(e)),this.addMissingPlugins(t,false,e)):e=e.filter(void 0!==t.basePlugins?e=>!(t.basePlugins.includes(e)||t.supportedPlugins.includes(e)):e=>!t.supportedPlugins.includes(e))}),[...Object.keys({}),...e]}addMissingPlugins(e,t,n){const s=e.shouldAddMissingPlugins||t;let i;i=e.activePluginName?[...e.basePlugins||[],e.activePluginName]:[...e.supportedPlugins];const r=i.filter(e=>!n.includes(e));r.length>0&&(s&&n.push(...r),this.logger.warn(((e,t,n,s)=>{const i=1===n.length,r=i?` '${n[0]}' plugin was`:` ['${n.join("', '")}'] plugins were`,o=`${e}${he}${t}, but${r} not configured to load.`;return s?`${o} So, ${i?"the plugin":"those plugins"} will be loaded automatically.`:`${o} Ignore if this was intentional. Otherwise, consider adding ${i?"it":"them"} to the 'plugins' load API option.`})(J,e.configurationStatusStr,r,s)))}setActivePlugins(){const e=this.getPluginsToLoadBasedOnConfig(),t=[...Object.keys(qn),...jn],n=[],s=[];e.forEach(e=>{t.includes(e)?n.push(e):s.push(e)}),s.length>0&&this.logger.warn(`${J}${he}Ignoring unknown plugins: ${s.join(", ")}.`),Ge(()=>{en.plugins.totalPluginsToLoad.value=e.length,en.plugins.activePlugins.value=n,en.plugins.failedPlugins.value=s})}registerLocalPlugins(){Object.values(qn).forEach(e=>{b(e)&&en.plugins.activePlugins.value.includes(e().name)&&this.register([e()])})}registerRemotePlugins(){const e=(t=en.plugins.activePlugins.value,{...Qn(t)});var t;Promise.all(Object.keys(e).map(async t=>{await e[t]().then(e=>this.register([e.default()])).catch(e=>{en.plugins.failedPlugins.value=[...en.plugins.failedPlugins.value,t],this.onError(e,`Failed to load plugin "${t}"`,e)})})).catch(e=>{this.onError(e)})}invokeMultiple(e,...t){try{return this.engine.invokeMultiple(e,...t)}catch(t){return this.onError(t,e),[]}}invokeSingle(e,...t){try{return this.engine.invokeSingle(e,...t)}catch(t){return this.onError(t,e),null}}register(e){e.forEach(e=>{try{this.engine.register(e,en)}catch(t){en.plugins.failedPlugins.value=[...en.plugins.failedPlugins.value,e.name],this.onError(t,`Failed to register plugin "${e.name}"`)}})}unregisterLocalPlugins(){Object.values(qn).forEach(e=>{try{this.engine.unregister(e().name)}catch(t){this.onError(t,`Failed to unregister plugin "${e().name}"`)}})}onError(e,t,n){this.errorHandler.onError({error:e,context:J,customMessage:t,groupingHash:n})}}const Jn="cookieStorage",Xn="localStorage",Zn="sessionStorage",Yn="memoryStorage",es="none",ts={userId:"rl_user_id",userTraits:"rl_trait",anonymousId:"rl_anonymous_id",groupId:"rl_group_id",groupTraits:"rl_group_trait",initialReferrer:"rl_page_init_referrer",initialReferringDomain:"rl_page_init_referring_domain",sessionInfo:"rl_session",authToken:"rl_auth_token"},ns="clientDataInCookie",ss="clientDataInLocalStorage",is="clientDataInSessionStorage",rs=["userId","userTraits","anonymousId","groupId","groupTraits","initialReferrer","initialReferringDomain","sessionInfo","authToken"],os={[Jn]:ns,[Xn]:ss,[Yn]:"clientDataInMemory",[Zn]:is},as=(e,t)=>{try{return encodeURIComponent(e)}catch(e){return void t?.error("Failed to encode the cookie data.",e)}},ls=e=>{try{return decodeURIComponent(e)}catch(e){return}},us=()=>(e=>{const t={},n=e.split(/\s*;\s*/);let s;return n[0]?(n.forEach(e=>{s=e.split("=");const n=s[0]?ls(s[0]):void 0;n&&(t[n]=s[1]?ls(s[1]):void 0)}),t):t})(globalThis.document.cookie),cs=function(e,t,n,s){switch(arguments.length){case 4:case 3:case 2:return((e,t,n,s)=>{const i={...n||{}};let r=`${as(e,s)}=${as(t,s)}`;I(t)&&(i.maxage=-1),i.maxage&&(i.expires=new Date(+new Date+i.maxage)),i.path&&(r+=`; path=${i.path}`),i.domain&&(r+=`; domain=${i.domain}`),i.expires&&(r+=`; expires=${i.expires.toUTCString()}`),i.samesite&&(r+=`; samesite=${i.samesite}`),i.secure&&(r+="; secure"),globalThis.document.cookie=r})(e,t,n,s);case 1:return e?(e=>us()[e])(e):us();default:return us()}},ds=e=>{const t="function"!=typeof globalThis.URL?(e=>{const t=document.createElement("a");return t.href=e,t.hostname})(e):new URL(e).hostname,n=t?.split(".")??[],s=n[n.length-1],i=[];if(4===n.length&&s&&s===parseInt(s,10).toString())return i;if(n.length<=1)return n[0]&&-1!==n[0].indexOf("localhost")?["localhost"]:i;for(let e=n.length-2;e>=0;e-=1)i.push(n.slice(e).join("."));return i},gs=()=>{const e=`.${(e=>{const t=ds(e);for(let e=0;e<t.length;e+=1){const n=t[e],s="__tld__",i={domain:`${-1!==n.indexOf("localhost")?"":"."}${n}`};try{if(cs(s,1,i),cs(s))return cs(s,null,i),n}catch{try{cs(s,null,i)}catch{}}}return""})(globalThis.location.href)}`;return{maxage:31536e6,path:"/",domain:e&&"."!==e?e:void 0,samesite:"Lax",enabled:!0}};const hs=new class{isEnabled=!0;length=0;data={};constructor(e){this.options={enabled:!0},this.logger=e}configure(e){return this.options=O(this.options,e??{}),this.isEnabled=Boolean(this.options.enabled),this.options}setItem(e,t){return this.data[e]=t,this.length=Object.keys(this.data).length,t}getItem(e){return e in this.data?this.data[e]:null}removeItem(e){return e in this.data&&delete this.data[e],this.length=Object.keys(this.data).length,null}clear(){this.data={},this.length=0}key(e){return this.keys()[e]??null}keys(){return Object.keys(this.data)}}(dt);var ps,vs={exports:{}};var fs=(ps||(ps=1,vs.exports=function(){function e(e){return e=JSON.stringify(e),!!/^\{[\s\S]*\}$/.test(e)}function t(e){return void 0===e||"function"==typeof e?e+"":JSON.stringify(e)}function n(e){if("string"==typeof e)try{return JSON.parse(e)}catch(t){return e}}function s(e){return"[object Function]"==={}.toString.call(e)}function i(e){return"[object Array]"===Object.prototype.toString.call(e)}function r(e){var t="_Is_Incognit",n="yes";try{e||(e=window.localStorage),e.setItem(t,n),e.removeItem(t)}catch(t){var s={_data:{},setItem:function(e,t){return s._data[e]=String(t)},getItem:function(e){return s._data.hasOwnProperty(e)?s._data[e]:void 0},removeItem:function(e){return delete s._data[e]},clear:function(){return s._data={}}};e=s}finally{e.getItem(t)===n&&e.removeItem(t)}return e}var o=r();function a(){if(!(this instanceof a))return new a}a.prototype={set:function(n,s){if(n&&!e(n))o.setItem(n,t(s));else if(e(n))for(var i in n)this.set(i,n[i]);return this},get:function(e){if(void 0===e){var t={};return this.forEach(function(e,n){return t[e]=n}),t}if("?"===e.charAt(0))return this.has(e.substr(1));var s=arguments;if(s.length>1){for(var i={},r=0,a=s.length;r<a;r++){var l=n(o.getItem(s[r]));this.has(s[r])&&(i[s[r]]=l)}return i}return n(o.getItem(e))},clear:function(){return o.clear(),this},remove:function(e){var t=this.get(e);return o.removeItem(e),t},has:function(e){return{}.hasOwnProperty.call(this.get(),e)},keys:function(){var e=[];return this.forEach(function(t){e.push(t)}),e},forEach:function(e){for(var t=0,n=o.length;t<n;t++){var s=o.key(t);e(s,this.get(s))}return this},search:function(e){for(var t=this.keys(),n={},s=0,i=t.length;s<i;s++)t[s].indexOf(e)>-1&&(n[t[s]]=this.get(t[s]));return n},len:function(){return o.length}};var l=null;function u(t,n){var r=arguments,o=null;if(l||(l=a()),0===r.length)return l.get();if(1===r.length){if("string"==typeof t)return l.get(t);if(e(t))return l.set(t)}if(2===r.length&&"string"==typeof t){if(!n)return l.remove(t);if(n&&"string"==typeof n)return l.set(t,n);n&&s(n)&&(o=null,o=n(t,l.get(t)),u.set(t,o))}if(2===r.length&&i(t)&&s(n))for(var c=0,d=t.length;c<d;c++)o=n(t[c],l.get(t[c])),u.set(t[c],o);return u}for(var c in a.prototype)u[c]=a.prototype[c];return u}()),vs.exports);const ys=tn(fs),ms=e=>{const t=[22,1014];return e instanceof DOMException&&(["QuotaExceededError","NS_ERROR_DOM_QUOTA_REACHED"].includes(e.name)||t.includes(e.code))},bs=(e=Xn,t,n)=>{let s,i;const r=`${Q}${he}The "${e}" storage type is `;let o,a="unavailable",l=!0;try{switch(e){case Yn:return!0;case Jn:s=t,i="test_rudder_cookie";break;case Xn:s=t??globalThis.localStorage,i="test_rudder_ls";break;case Zn:s=t??globalThis.sessionStorage,i="test_rudder_ss";break;default:return!1}if(s&&(s.setItem(i,"true"),s.getItem(i)))return s.removeItem(i),!0;l=!1}catch(e){l=!1,o=e,ms(e)&&(a="full")}return l||n?.warn(`${r}${a}.`,o),!1};const ks=new class{isSupportAvailable=!0;isEnabled=!0;length=0;constructor(e){this.options={enabled:!0},this.logger=e}configure(e){return this.options=O(this.options,e??{}),this.isSupportAvailable=bs(Xn),this.isEnabled=Boolean(this.options.enabled&&this.isSupportAvailable),this.options}setItem(e,t){ys.set(e,t),this.length=ys.len()}getItem(e){const t=ys.get(e);return S(t)?null:t}removeItem(e){ys.remove(e),this.length=ys.len()}clear(){ys.clear(),this.length=0}key(e){return this.keys()[e]??null}keys(){return ys.keys()}}(dt);const Is=new class{isSupportAvailable=!0;isEnabled=!0;length=0;constructor(e){this.options={enabled:!0},this.logger=e}configure(e){return this.options=O(this.options,e??{}),this.isSupportAvailable=bs(Zn),this.isSupportAvailable&&(this.store=globalThis.sessionStorage),this.isEnabled=Boolean(this.options.enabled&&this.isSupportAvailable),this.options}setItem(e,t){this.store&&(this.store.setItem(e,t),this.length=this.store.length)}getItem(e){if(!this.store)return null;const t=this.store.getItem(e);return S(t)?null:t}removeItem(e){this.store&&(this.store.removeItem(e),this.length=this.store.length)}clear(){this.store?.clear(),this.length=0}key(e){return this.store?.key(e)??null}keys(){const e=[];if(!this.store)return e;for(let t=0;t<this.store.length;t+=1){const n=this.store.key(t);null!==n&&e.push(n)}return e}}(dt);const Ss=new class{isSupportAvailable=!0;isEnabled=!0;length=0;constructor(e){this.logger=e}configure(e){return this.options||(this.options=gs()),this.options=O(this.options,e??{}),this.options.sameDomainCookiesOnly&&delete this.options.domain,this.isSupportAvailable=bs(Jn,this),this.isEnabled=Boolean(this.options.enabled&&this.isSupportAvailable),this.options}setItem(e,t){return cs(e,t,this.options,this.logger),this.length=Object.keys(cs()).length,!0}getItem(e){const t=cs(e);return S(t)?null:t}removeItem(e){const t=this.setItem(e,null);return this.length=Object.keys(cs()).length,t}clear(){}key(e){return this.keys()[e]??null}keys(){return Object.keys(cs())}}(dt),Es=e=>{switch(e){case Xn:return ks;case Zn:return Is;case Yn:return hs;case Jn:return Ss;default:return hs}},Ts=(e={},t={},n={},s={})=>{var i;(e=>{const t=Ss.configure(e);en.storage.cookie.value={maxage:t.maxage,path:t.path,domain:t.domain,samesite:t.samesite,expires:t.expires,secure:t.secure}})(e),i=t,ks.configure(i),(e=>{hs.configure(e)})(n),(e=>{Is.configure(e)})(s)};class As{constructor(e,t,n){this.id=e.id,this.name=e.name,this.isEncrypted=e.isEncrypted??!1,this.validKeys=e.validKeys??{},this.engine=t,this.noKeyValidation=0===Object.keys(this.validKeys).length,this.noCompoundKey=e.noCompoundKey,this.originalEngine=this.engine,this.errorHandler=e.errorHandler,this.logger=e.logger,this.pluginsManager=n}createValidKey(e){const{name:t,id:n,validKeys:s,noKeyValidation:i,noCompoundKey:r}=this;if(i)return r?e:[t,n,e].join(".");let o;return Object.values(s).forEach(s=>{s===e&&(o=r?e:[t,n,e].join("."))}),o}swapQueueStoreToInMemoryEngine(){const{name:e,id:t,validKeys:n,noCompoundKey:s}=this,i=Es(Yn);Object.keys(n).forEach(r=>{const o=this.get(n[r]),a=s?r:[e,t,r].join(".");i.setItem(a,o),this.remove(r)}),this.engine=i}set(e,t){const n=this.createValidKey(e);if(n)try{this.engine.setItem(n,this.encrypt(ye(t,!1,[],this.logger)))}catch(n){if(ms(n))this.logger.warn(`${`Store ${this.id}`}${he}The storage is either full or unavailable, so the data will not be persisted. Switching to in-memory storage.`),this.swapQueueStoreToInMemoryEngine(),this.set(e,t);else{const t=(e=>`Failed to save the value for "${e}" to storage`)(e);this.onError(n,t,t)}}}get(e){const t=this.createValidKey(e);let n;try{return t?(n=this.decrypt(this.engine.getItem(t)),E(n)||""===n?null:JSON.parse(n)):null}catch(t){const n=(e=>`Failed to retrieve or parse data for "${e}" from storage`)(e);return this.onError(t,n,n),null}}remove(e){const t=this.createValidKey(e);t&&this.engine.removeItem(t)}getOriginalEngine(){return this.originalEngine}decrypt(e){return E(e)?null:this.crypto(e,"decrypt")}encrypt(e){return this.crypto(e,"encrypt")}crypto(e,t){const n=!this.isEncrypted||!e||"string"!=typeof e||""===(e=>e.replace(/^\s+|\s+$/gm,""))(e);if(n)return e;const s=`storage.${t}`,i=this.pluginsManager?this.pluginsManager.invokeSingle(s,e):e;return void 0===i?e:i??""}onError(e,t,n){this.errorHandler.onError({error:e,context:`Store ${this.id}`,customMessage:t,groupingHash:n})}}class ws{stores={};isInitialized=!1;constructor(e,t,n){this.errorHandler=t,this.logger=n,this.pluginsManager=e}init(){if(this.isInitialized)return;const e=en.loadOptions.value,t={cookieStorageOptions:{samesite:e.sameSiteCookie,secure:e.secureCookie,domain:e.setCookieDomain,sameDomainCookiesOnly:e.sameDomainCookiesOnly},localStorageOptions:{},inMemoryStorageOptions:{},sessionStorageOptions:{}};Ts(R(O(t.cookieStorageOptions??{},en.storage.cookie?.value??{})),R(t.localStorageOptions),R(t.inMemoryStorageOptions),R(t.sessionStorageOptions)),this.initClientDataStores(),this.isInitialized=!0}initClientDataStores(){this.initializeStorageState();[Yn,Xn,Jn,Zn].forEach(e=>{Es(e)?.isEnabled&&this.setStore({id:os[e],name:os[e],isEncrypted:!0,noCompoundKey:!0,type:e,errorHandler:this.errorHandler,logger:this.logger})})}initializeStorageState(){let e=en.storage.type.value,t=en.loadOptions.value.storage?.entries;const n=en.consents.postConsent.value.storage;(T(n?.type)||T(n?.entries))&&(e=n?.type,t=n?.entries);let s=!0,i={};rs.forEach(n=>{const r=n,o=n,a=t?.[r]?.type,l=((e,t)=>{let n;if(e.consents.preConsent.value.enabled)switch(e.consents.preConsent.value.storage?.strategy){case"none":n=es;break;case"session":"sessionInfo"!==t&&(n=es);break;case"anonymousId":"anonymousId"!==t&&(n=es)}return n})(en,n),u=l??a??e??pt,c=this.getResolvedStorageTypeForEntry(u,n);c!==es&&(s=!1),i={...i,[n]:{type:c,key:ts[o]}}}),Ge(()=>{en.storage.type.value=e,en.storage.entries.value=i,en.storage.trulyAnonymousTracking.value=s})}getResolvedStorageTypeForEntry(e,t){let n=e;switch(e){case Xn:Es(Xn)?.isEnabled||(n=Yn);break;case Zn:Es(Zn)?.isEnabled||(n=Yn);break;case Yn:case es:break;default:n=Es(Jn)?.isEnabled?Jn:Es(Xn)?.isEnabled?Xn:Es(Zn)?.isEnabled?Zn:Yn}return n!==e&&this.logger.warn(((e,t,n,s)=>`${e}${he}The storage type "${n}" is not available for entry "${t}". The SDK will initialize the entry with "${s}" storage type instead.`)("StoreManager",t,e,n)),n}setStore(e){const t=Es(e.type);return this.stores[e.id]=new As(e,t,this.pluginsManager),this.stores[e.id]}getStore(e){return this.stores[e]}}const Cs=e=>{const t=new URL(e),{host:n,protocol:s}=t,i=n.split(".");let r;return r=i.length>2?`${i[i.length-2]}.${i[i.length-1]}`:n,{topDomain:r,protocol:s}},$s=(e,t)=>`${t?window.location.origin:(e=>{const{topDomain:t,protocol:n}=Cs(e);return`${n}//${t}`})(window.location.href)}/${e.startsWith("/")?e.substring(1):e}`,Ps=e=>e?.endsWith("/")?Ps(e.substring(0,e.length-1)):e,Os=e=>{try{return new URL(e).host}catch(e){return null}},Ds=e=>Os(e)??"",Rs=e=>{const t={};try{const n=new URL(e),s="utm_";n.searchParams.forEach((e,n)=>{if(n.startsWith(s)){let i=n.substring(s.length);"campaign"===i&&(i="name"),t[i]=e}})}catch(e){}return t},Ns=e=>{if(!k(e))return!1;try{return b(globalThis.URL)&&new URL(e),Tt.test(e)}catch(e){return!1}},Ms="none",Ls="immediate",Bs=e=>D(e)||Array.isArray(e),xs=(e,t)=>{let{provider:n}=e;const s=n?Nt[n]:void 0;var i;return n&&!s&&(t.error((i=Nt,`${q}${he}The consent manager "${n}" is not supported. Please choose one of the following supported consent managers: "${Object.keys(i)}".`)),n=void 0),{provider:n,consentManagerPluginName:s}},Us=(e,t)=>{let n,s,i=[],r=[],o=!1,a=!0===e?.enabled;D(e)&&a&&(({provider:s,consentManagerPluginName:n}=xs(e,t)),Bs(e.allowedConsentIds)&&(i=e.allowedConsentIds,o=!0),Bs(e.deniedConsentIds)&&(r=e.deniedConsentIds,o=!0));const l={allowedConsentIds:i,deniedConsentIds:r};return a=a&&Boolean(n),{provider:s,consentManagerPluginName:n,initialized:o,enabled:a,consentsData:l}},js=e=>{var t;en.reporting.isErrorReportingEnabled.value=(t=e.source.config,!0===t?.statsCollection?.errors?.enabled&&!window.chrome?.runtime?.id),en.reporting.isMetricsReportingEnabled.value=(e=>!0===e?.statsCollection?.metrics?.enabled)(e.source.config)},_s=e=>{const{useServerSideCookies:t,dataServiceEndpoint:n,storage:s,setCookieDomain:i,sameDomainCookiesOnly:r}=en.loadOptions.value;let o,a=s?.cookie,l=!1;if(t){l=t;const s=a.domain??i,u=T(s)&&!(e=>{const{topDomain:t}=Cs(window.location.href);return t===e})(x(s))||r,c=$s(n??"rsaRequest",u);if(Ns(c)){o=Ps(c);const t=Os(window.location.href),n=Os(c);t!==n&&(a={...a,samesite:"None",secure:!0}),!r&&u&&n!==x(s)&&(l=!1,e.warn(((e,t,n)=>`${e}${he}The provided cookie domain (${t}) does not match the current webpage's domain (${n}). Hence, the cookies will be set client-side.`)(q,s,n)))}else l=!1}return{sscEnabled:l,cookieOptions:a,finalDataServiceUrl:o}},Hs=e=>{const{storage:t}=en.loadOptions.value;let n=t?.type;T(n)&&!(e=>"string"==typeof e&&ht.includes(e))(n)&&(e.warn(((e,t,n)=>`${e}${he}The storage type "${t}" is not supported. Please choose one of the following supported types: "${ht}". The default type "${n}" will be used instead.`)(q,n,pt)),n=pt);let s=t?.encryption?.version;const i=s&&Mt[s];var r,o;!S(s)&&S(i)?(e.warn((r=Mt,o=Dt,`${q}${he}The storage encryption version "${s}" is not supported. Please choose one of the following supported versions: "${Object.keys(r)}". The default version "${o}" will be used instead.`)),s=Dt):S(s)&&(s=Dt);const a=t?.migrate,l=a&&s===Dt;!0===a&&l!==a&&e.warn(((e,t,n)=>`${e}${he}The storage data migration has been disabled because the configured storage encryption version (${t}) is not the latest (${n}). To enable storage data migration, please update the storage encryption version to the latest version.`)(q,s,Dt));const{sscEnabled:u,finalDataServiceUrl:c,cookieOptions:d}=_s(e);Ge(()=>{en.storage.type.value=n,en.storage.cookie.value=d,en.serverCookies.isEnabledServerSideCookies.value=u,en.serverCookies.dataServiceUrl.value=c,en.storage.encryptionPluginName.value=Mt[s],en.storage.migrate.value=l})},Fs=e=>{const{provider:t,consentManagerPluginName:n,initialized:s,enabled:i,consentsData:r}=Us(en.loadOptions.value.consentManagement,e),o=en.loadOptions.value.preConsent;let a=o?.storage?.strategy??Ms;var l,u;T(a)&&!["none","session","anonymousId"].includes(a)&&(a=Ms,e.warn((l=q,u=o?.storage?.strategy,`${l}${he}The pre-consent storage strategy "${u}" is not supported. Please choose one of the following supported strategies: "none, session, anonymousId". The default strategy "${Ms}" will be used instead.`)));let c=o?.events?.delivery??Ls;T(c)&&!["immediate","buffer"].includes(c)&&(c=Ls,e.warn(((e,t,n)=>`${e}${he}The pre-consent events delivery type "${t}" is not supported. Please choose one of the following supported types: "immediate, buffer". The default type "${n}" will be used instead.`)(q,o?.events?.delivery,Ls))),Ge(()=>{en.consents.activeConsentManagerPluginName.value=n,en.consents.initialized.value=s,en.consents.enabled.value=i,en.consents.data.value=r,en.consents.provider.value=t,en.consents.preConsent.value={enabled:!0===en.loadOptions.value.preConsent?.enabled&&!1===s&&!0===i,storage:{strategy:a},events:{delivery:c}}})},Gs=e=>{if(en.dataPlaneEvents.deliveryEnabled.value){const t="XhrQueue";let n=t;en.loadOptions.value.useBeacon&&(en.capabilities.isBeaconAvailable.value?n="BeaconQueue":(n=t,e.warn(`${q}${he}The Beacon API is not supported by your browser. The events will be sent using XHR instead.`))),Ge(()=>{en.dataPlaneEvents.eventsQueuePluginName.value=n})}},Ks=(e,t,n,s,i)=>{const r=new URLSearchParams({p:"cdn",v:we,build:At,writeKey:t,lockIntegrationsVersion:n.toString(),lockPluginsVersion:s.toString()});let o=Ot,a=r,l="/sourceConfig/",u="";if(Ns(e)){const t=new URL(e);Ps(t.pathname).endsWith("/sourceConfig")||(t.pathname=`${Ps(t.pathname)}/sourceConfig/`),t.pathname=t.pathname.replace(/\/{2,}/g,"/"),r.forEach((e,n)=>{null===t.searchParams.get(n)&&t.searchParams.set(n,e)}),o=t.origin,l=t.pathname,a=t.searchParams,u=t.hash}else i.warn(((e,t)=>`${e}${he}The provided source config URL "${t}" is invalid. Using the default source config URL instead.`)(q,e));return`${o}${l}?${a}${u}`},Vs=(e,t,n,s,i,r,o)=>{let a;if(r){if(!Ns(r))return o.error(`${q}${he}The base URL "${r}" for ${e} is not valid.`),null;a=Ps(r)}else if(a=n,"cdn"===en.context.app.value.installType){const e=(()=>{const e=document.querySelector("script[data-rsa-write-key]");if(e&&e.dataset.rsaWriteKey===en.lifecycle.writeKey.value)return e.src;const t=document.getElementsByTagName("script"),n=/(?:^|\/)rsa(\.min)?\.js$/;for(const e of t){const t=e.getAttribute("src");if(t&&n.test(t))return t}})();e&&(a=e.split("/").slice(0,-1).concat(t).join("/"))}return i&&(a=a.replace(new RegExp(`/${Ct}/${At}/${t}$`),`/${s}/${At}/${t}`)),a};class zs{constructor(e,t,n){this.errorHandler=t,this.logger=n,this.httpClient=e,this.onError=this.onError.bind(this),this.processConfig=this.processConfig.bind(this)}attachEffects(){at(()=>{this.logger.setMinLogLevel(en.lifecycle.logLevel.value)})}init(){const{logLevel:e,configUrl:t,lockIntegrationsVersion:n,lockPluginsVersion:s,destSDKBaseURL:i,pluginsSDKBaseURL:r,integrations:o}=en.loadOptions.value,a=((e,t,n,s)=>Vs("integrations",St,$t,e,t,n,s))(we,n,i,this.logger);if(I(a))return;let l;l=((e,t,n,s)=>Vs("plugins",Et,Pt,e,t,n,s))(we,s,r,this.logger),null!==l&&(this.attachEffects(),en.lifecycle.activeDataplaneUrl.value=Ps(en.lifecycle.dataPlaneUrl.value),Hs(this.logger),Fs(this.logger),Gs(this.logger),Ge(()=>{en.lifecycle.integrationsCDNPath.value=a,en.lifecycle.pluginsCDNPath.value=l,e&&(en.lifecycle.logLevel.value=e),en.lifecycle.sourceConfigUrl.value=Ks(t,en.lifecycle.writeKey.value,n,s,this.logger),en.metrics.metricsServiceUrl.value=`${en.lifecycle.activeDataplaneUrl.value}/rsaMetrics`,en.nativeDestinations.loadOnlyIntegrations.value=o}),this.getConfig())}onError(e,t,n){this.errorHandler.onError({error:e,context:q,customMessage:t,groupingHash:n})}processConfig(e,t){if(!T(e))return void(T(t)?this.onError(t.error,yt):this.onError(new Error(yt)));let n;try{n=k(e)?JSON.parse(e):e}catch(e){return void this.onError(e,vt)}if(!(e=>$(e)&&$(e.source)&&!E(e.source.id)&&$(e.source.config)&&Array.isArray(e.source.destinations))(n))return void this.onError(new Error(vt));if(!1===n.source.enabled)return void this.logger.error("The source is disabled. Please enable the source in the dashboard to send events.");js(n);const s=n.source.destinations.length>0?n.source.destinations.map(e=>{return{id:e.id,displayName:e.destinationDefinition.displayName,enabled:e.enabled,config:e.config,shouldApplyDeviceModeTransformation:e.shouldApplyDeviceModeTransformation??!1,propagateEventsUntransformedOnError:e.propagateEventsUntransformedOnError??!1,userFriendlyId:(t=e.destinationDefinition.displayName,n=e.id,`${t.replaceAll(" ","-")}___${n}`),isCustomIntegration:"Custom Device Mode"===e.destinationDefinition.displayName};var t,n}):[];Ge(()=>{en.source.value={config:n.source.config,name:n.source.name,id:n.source.id,workspaceId:n.source.workspaceId},en.nativeDestinations.configuredDestinations.value=s,en.plugins.pluginsToLoadFromConfig.value=en.loadOptions.value.plugins??[],(e=>{let t,n=en.consents.resolutionStrategy.value;$(e.consentManagementMetadata)&&(en.consents.provider.value&&(n=e.consentManagementMetadata.providers.find(e=>e.provider===en.consents.provider.value)?.resolutionStrategy??en.consents.resolutionStrategy.value),t=e.consentManagementMetadata),"custom"===en.consents.provider.value&&(n=void 0),Ge(()=>{en.consents.metadata.value=g(t),en.consents.resolutionStrategy.value=n})})(n),en.lifecycle.status.value="configured"})}getConfig(){const e=en.loadOptions.value.getSourceConfig;if(e){if(!b(e))return void this.logger.error((t=q,`${t}${he}The "getSourceConfig" load API option must be a function that returns valid source configuration data.`));const n=e();n instanceof Promise?n.then(e=>this.processConfig(e)).catch(e=>{this.onError(e,"SourceConfig")}):this.processConfig(n)}else this.httpClient.getAsyncData({url:en.lifecycle.sourceConfigUrl.value,options:{headers:{"Content-Type":void 0}},callback:this.processConfig});var t}}const Qs=(e=()=>document)=>e()?.referrer||"$direct",qs=(e=()=>globalThis.location,t=()=>document)=>{const n=e(),s=((e=()=>document)=>{const t=e().getElementsByTagName("link");let n="";for(let e=0;t[e];e+=1){const s=t[e];if("canonical"===s.getAttribute("rel")&&!n){n=s.getAttribute("href")??"";break}}return n})(t);let i=n.pathname;const{href:r}=n;let o=r;const{search:a}=n;if(s)try{const e=new URL(s);o=""===e.search?s+a:s,i=e.pathname}catch(e){}const l=(e=>{let t=e;try{const n=new URL(e);t=n.origin+n.pathname+n.search}catch(e){}return t})(o),{title:u}=t(),c=Qs(t);return{path:i,referrer:c,referring_domain:Ds(c),search:a,title:u,url:l,tab_url:r}},Ws={URL:()=>!b(globalThis.URL)||!b(globalThis.URLSearchParams),Promise:()=>!b(globalThis.Promise),"Number.isNaN":()=>!b(globalThis.Number.isNaN),"Number.isInteger":()=>!b(globalThis.Number.isInteger),"Array.from":()=>!b(globalThis.Array.from),"Array.prototype.find":()=>!b(globalThis.Array.prototype.find),"Array.prototype.includes":()=>!b(globalThis.Array.prototype.includes),"String.prototype.endsWith":()=>!b(globalThis.String.prototype.endsWith),"String.prototype.startsWith":()=>!b(globalThis.String.prototype.startsWith),"String.prototype.includes":()=>!b(globalThis.String.prototype.includes),"String.prototype.replaceAll":()=>!b(globalThis.String.prototype.replaceAll),"String.fromCodePoint":()=>!b(globalThis.String.fromCodePoint),"Object.entries":()=>!b(globalThis.Object.entries),"Object.values":()=>!b(globalThis.Object.values),"Object.assign":()=>!b(globalThis.Object.assign),"Object.fromEntries":()=>!b(globalThis.Object.fromEntries),"Element.prototype.dataset":()=>!(()=>{const e=globalThis.document.createElement("div");return e.setAttribute("data-a-b","c"),!!e.dataset&&"c"===e.dataset.aB})(),TextEncoder:()=>!b(globalThis.TextEncoder)||!b(globalThis.TextDecoder),requestAnimationFrame:()=>!b(globalThis.requestAnimationFrame)||!b(globalThis.cancelAnimationFrame),CustomEvent:()=>!b(globalThis.CustomEvent),"navigator.sendBeacon":()=>!b(globalThis.navigator.sendBeacon),ArrayBuffer:()=>!b(globalThis.Uint8Array),Set:()=>!b(globalThis.Set),atob:()=>!b(globalThis.atob)},Js=`https://polyfill-fastly.io/v3/polyfill.min.js?version=3.111.0&features=${Object.keys(Ws).join("%2C")}`,Xs="rudderstackPolyfill",Zs=()=>!E(globalThis.navigator.userAgentData),Ys=()=>{let e={density:0,width:0,height:0,innerWidth:0,innerHeight:0};return e={width:globalThis.screen.width,height:globalThis.screen.height,density:globalThis.devicePixelRatio,innerWidth:globalThis.innerWidth,innerHeight:globalThis.innerHeight},e};class ei{constructor(e,t,n){this.httpClient=e,this.errorHandler=t,this.logger=n,this.externalSrcLoader=new _e(this.logger),this.onError=this.onError.bind(this),this.onReady=this.onReady.bind(this)}init(){this.prepareBrowserCapabilities(),this.attachWindowListeners()}detectBrowserCapabilities(){Ge(()=>{en.capabilities.storage.isCookieStorageAvailable.value=bs(Jn,Es(Jn),this.logger),en.capabilities.storage.isLocalStorageAvailable.value=bs(Xn,void 0,this.logger),en.capabilities.storage.isSessionStorageAvailable.value=bs(Zn,void 0,this.logger),en.capabilities.isBeaconAvailable.value=!E(globalThis.navigator.sendBeacon)&&b(globalThis.navigator.sendBeacon),en.capabilities.isUaCHAvailable.value=Zs(),en.capabilities.isCryptoAvailable.value=!E(globalThis.crypto)&&b(globalThis.crypto.getRandomValues),en.capabilities.isIE11.value=de(),en.capabilities.isOnline.value=globalThis.navigator.onLine,en.context.userAgent.value=((e=()=>globalThis.navigator)=>{const t=e();if(S(t))return null;let{userAgent:n}=t;const{brave:s}=t;if(s&&Object.getPrototypeOf(s).isBrave){const e=n.match(/(chrome)\/([\w.]+)/i);e&&(n=`${n} Brave/${e[2]}`)}return n})(),en.context.locale.value=((e=()=>globalThis.navigator)=>{const t=e();return S(t)?null:t.language??t.browserLanguage})(),en.context.screen.value=Ys(),en.context.timezone.value=(()=>{const e=/([A-Z]+[+-]\d+)/.exec((new Date).toString());return e?.[1]?e[1]:"NA"})(),Zs()&&((e,t="none")=>{"none"===t&&e(void 0),"default"===t&&e(navigator.userAgentData),"full"===t&&navigator.userAgentData?.getHighEntropyValues(["architecture","bitness","brands","mobile","model","platform","platformVersion","uaFullVersion","fullVersionList","wow64"]).then(t=>{e(t)}).catch(()=>{e()})})(e=>{en.context["ua-ch"].value=e},en.loadOptions.value.uaChTrackLevel)}),at(()=>{!0===en.loadOptions.value.sendAdblockPage&&void 0!==en.lifecycle.sourceConfigUrl.value&&$n(this.httpClient)})}prepareBrowserCapabilities(){en.capabilities.isLegacyDOM.value=(()=>{const e=Object.keys(Ws);let t=!1;for(let n=0;n<e.length;n++){const s=Ws[e[n]];if(b(s)&&s()){t=!0;break}}return t})();const e=en.loadOptions.value.polyfillURL;let t=Js;A(e)&&(Ns(e)?t=e:this.logger.warn(((e,t)=>`${e}${he}The provided polyfill URL "${t}" is invalid. The default polyfill URL will be used instead.`)(Q,e)));if(en.loadOptions.value.polyfillIfRequired&&en.capabilities.isLegacyDOM.value&&Ns(t)){const e=t!==en.loadOptions.value.polyfillURL;if(e){const e=`RS_polyfillCallback_${en.lifecycle.writeKey.value}`,n=()=>{this.onReady(),delete globalThis[e]};globalThis[e]=n,t=`${t}&callback=${e}`}this.externalSrcLoader.loadJSFile({url:t,id:Xs,async:!0,timeout:1e4,callback:n=>{n?e||this.onReady():this.onError(new Error(((e,t)=>`Failed to load the polyfill script with ID "${e}" from URL ${t}.`)(Xs,t)))}})}else this.onReady()}attachWindowListeners(){globalThis.addEventListener("offline",()=>{en.capabilities.isOnline.value=!1}),globalThis.addEventListener("online",()=>{en.capabilities.isOnline.value=!0}),globalThis.addEventListener("resize",function(e,t,n=250){let s;return(...i)=>{globalThis.clearTimeout(s),s=globalThis.setTimeout(()=>{e.apply(t,i)},n)}}(()=>{en.context.screen.value=Ys()},this))}onReady(){this.detectBrowserCapabilities(),en.lifecycle.status.value="browserCapabilitiesReady"}onError(e,t){this.errorHandler.onError({error:e,context:Q,groupingHash:t})}}const ti=["integrations","anonymousId","originalTimestamp"],ni=["library","consentManagement","userAgent","ua-ch","screen"],si=["id","anonymous_id","user_id","sent_at","timestamp","received_at","original_timestamp","event","event_text","channel","context_ip","context_request_ip","context_passed_ip","group_id","previous_id"],ii=e=>"number"==typeof e&&!Number.isNaN(e),ri=e=>ii(e)&&e>=0&&Number.isInteger(e),oi=e=>{const{cutOff:t}=e,n=Date.now();return Boolean(t?.enabled&&t.expiresAt&&n>t.expiresAt)},ai=e=>Boolean(!e.expiresAt||Date.now()>e.expiresAt)||oi(e),li=(e,t)=>{return!!(e&&ri(e)&&(n=10,s=e,s.toString().length>=n))||(t.warn(((e,t,n)=>`${e}${he}The provided session ID (${t}) is either invalid, not a positive integer, or not at least "${n}" digits long. A new session ID will be auto-generated instead.`)(X,e,10)),!1);var n,s},ui=(e,t)=>({id:li(e,t)?e:Date.now(),sessionStart:void 0,manualTrack:!0}),ci=e=>Boolean(e===Jn||e===Xn||e===Zn||e===Yn),di=()=>ce(),gi=e=>{const t=qs(),n={};return Object.keys(t).forEach(s=>{n[s]=e?.[s]||t[s]}),n.initial_referrer=e?.initial_referrer||en.session.initialReferrer.value,n.initial_referring_domain=e?.initial_referring_domain||en.session.initialReferringDomain.value,n},hi=(e,t,n)=>{$(e)&&Object.keys(e).forEach(e=>{(si.includes(e)||si.includes(e.toLowerCase()))&&n.warn(((e,t,n,s)=>`${e}${he}The "${t}" property defined under "${n}" is a reserved keyword. Please choose a different property name to avoid conflicts with reserved keywords (${s}).`)(W,e,t,si))})},pi=(e,t,n)=>{let s=e;return Object.keys(t).forEach(e=>{if(!ti.includes(e)&&!ni.includes(e))if("context"!==e)s=O(s,{[e]:t[e]});else if(!S(t[e])&&$(t[e])){const n={};Object.keys(t[e]).forEach(s=>{ni.includes(s)||(n[s]=t[e][s])}),s=O(s,{...n})}else n.warn(`${W}${he}Please make sure that the "context" property in the event API's "options" argument is a valid object literal with key-value pairs.`)}),s},vi=(e,t,n)=>{$(t)&&(((e,t)=>{t.anonymousId&&k(t.anonymousId)&&(e.anonymousId=t.anonymousId),D(t.integrations)&&(e.integrations=t.integrations),t.originalTimestamp&&k(t.originalTimestamp)&&(e.originalTimestamp=t.originalTimestamp)})(e,t),e.context=pi(e.context,t,n))},fi=(e,t,n,s)=>{const i={channel:"web",context:{traits:g(en.session.userTraits.value),sessionId:en.session.sessionInfo.value.id||void 0,sessionStart:en.session.sessionInfo.value.sessionStart||void 0,...en.consents.enabled.value&&{consentManagement:{deniedConsentIds:g(en.consents.data.value.deniedConsentIds),allowedConsentIds:g(en.consents.data.value.allowedConsentIds),provider:en.consents.provider.value,resolutionStrategy:en.consents.resolutionStrategy.value}},"ua-ch":en.context["ua-ch"].value,app:en.context.app.value,library:en.context.library.value,userAgent:en.context.userAgent.value,os:en.context.os.value,locale:en.context.locale.value,screen:en.context.screen.value,campaign:Rs(globalThis.location.href),page:gi(n),timezone:en.context.timezone.value,...en.autoTrack.enabled.value&&{autoTrack:{...en.autoTrack.pageLifecycle.enabled.value&&{page:{pageViewId:en.autoTrack.pageLifecycle.pageViewId.value}}}}},originalTimestamp:ge(new Date),messageId:ce(),userId:e.userId||en.session.userId.value};ci(en.storage.entries.value.anonymousId?.type)?i.anonymousId=en.session.anonymousId.value:i.anonymousId=di(),en.storage.trulyAnonymousTracking.value&&(i.context.trulyAnonymousTracking=!0),"identify"===e.type&&(i.context.traits=en.storage.entries.value.userTraits?.type!==es?g(en.session.userTraits.value):e.context.traits),"group"===e.type&&((e.groupId||en.session.groupId.value)&&(i.groupId=e.groupId||en.session.groupId.value),(e.traits||en.session.groupTraits.value)&&(i.traits=en.storage.entries.value.groupTraits?.type!==es?g(en.session.groupTraits.value):e.traits));const r=O(e,i);return void 0===r.event&&(r.event=null),void 0===r.properties&&(r.properties=null),vi(r,t,s),((e,t)=>{const{properties:n,traits:s,context:i}=e,{traits:r}=i;hi(n,"properties",t),hi(s,"traits",t),hi(r,"context.traits",t)})(r,s),r.integrations=(e=>{let t;return t=en.loadOptions.value.useGlobalIntegrationsConfigInEvents?en.consents.postConsent.value.integrations??en.nativeDestinations.loadOnlyIntegrations.value:e||It,g(t)})(r.integrations),r};class yi{constructor(e){this.logger=e}generatePageEvent(e,t,n,s){let i=n??{};i=((e,t)=>{const n=t?.page||{},s=e,i=qs();return Object.keys(i).forEach(e=>{S(s[e])&&(s[e]=n[e]||i[e])}),S(s.initial_referrer)&&(s.initial_referrer=n.initial_referrer||en.session.initialReferrer.value),S(s.initial_referring_domain)&&(s.initial_referring_domain=n.initial_referring_domain||en.session.initialReferringDomain.value),s})(i,s);return fi({properties:i,name:t,category:e,type:"page"},s,i,this.logger)}generateTrackEvent(e,t,n){return fi({properties:t,event:e,type:"track"},n,void 0,this.logger)}generateIdentifyEvent(e,t,n){return fi({userId:e,type:"identify",context:{traits:t}},n,void 0,this.logger)}generateAliasEvent(e,t,n){const s=fi({previousId:t,type:"alias"},n,void 0,this.logger);return s.userId=e??s.userId,s}generateGroupEvent(e,t,n){const s={type:"group"};return e&&(s.groupId=e),t&&(s.traits=t),fi(s,n,void 0,this.logger)}create(e){let t;switch(e.type){case"page":t=this.generatePageEvent(e.category,e.name,e.properties,e.options);break;case"track":t=this.generateTrackEvent(e.name,e.properties,e.options);break;case"identify":t=this.generateIdentifyEvent(e.userId,e.traits,e.options);break;case"alias":t=this.generateAliasEvent(e.to,e.from,e.options);break;default:t=this.generateGroupEvent(e.groupId,e.traits,e.options)}return t}}class mi{constructor(e,t,n,s){this.eventRepository=e,this.userSessionManager=t,this.errorHandler=n,this.logger=s,this.eventFactory=new yi(this.logger)}init(){this.eventRepository.init()}resume(){this.eventRepository.resume()}addEvent(e){this.userSessionManager.refreshSession();const t=this.eventFactory.create(e);this.eventRepository.enqueue(t,e.callback)}}class bi{constructor(e,t,n,s,i){this.storeManager=t,this.pluginsManager=e,this.logger=i,this.errorHandler=s,this.httpClient=n,this.onError=this.onError.bind(this),this.serverSideCookieDebounceFuncs={},this.serverSideCookiesRequestInProgress={}}init(){this.syncStorageDataToState(),this.registerEffects()}syncStorageDataToState(){this.migrateStorageIfNeeded(),this.migrateDataFromPreviousStorage(),this.setUserId(this.getUserId()),this.setUserTraits(this.getUserTraits()),this.setGroupId(this.getGroupId()),this.setGroupTraits(this.getGroupTraits());const{externalAnonymousIdCookieName:e,anonymousIdOptions:t}=en.loadOptions.value;let n;A(e)&&"string"==typeof e&&(n=this.getExternalAnonymousIdByCookieName(e)),this.setAnonymousId(n??this.getAnonymousId(t)),this.setAuthToken(this.getAuthToken()),this.setInitialReferrerInfo(),this.configureSessionTracking()}configureSessionTracking(){let e;if(this.isPersistenceEnabledForStorageEntry("sessionInfo")){const t=this.getConfiguredSessionTrackingInfo(),n=this.getSessionInfo()??xt.sessionInfo;e={autoTrack:t.autoTrack&&!0!==n.manualTrack,timeout:t.timeout,manualTrack:n.manualTrack,expiresAt:n.expiresAt,id:n.id,sessionStart:n.sessionStart},e.autoTrack||!0===e.manualTrack?!0===t.cutOff?.enabled&&(e.cutOff={enabled:!0,duration:t.cutOff.duration,expiresAt:n.cutOff?.expiresAt}):e=xt.sessionInfo}else e=xt.sessionInfo;en.session.sessionInfo.value=e,en.session.sessionInfo.value.autoTrack&&this.startOrRenewAutoTracking(en.session.sessionInfo.value)}setInitialReferrerInfo(){const e=this.getInitialReferrer(),t=this.getInitialReferringDomain();if(e&&t)this.setInitialReferrer(e),this.setInitialReferringDomain(t);else{const t=e||Qs();this.setInitialReferrer(t),this.setInitialReferringDomain(Ds(t))}}isPersistenceEnabledForStorageEntry(e){return ci(en.storage.entries.value[e]?.type)}migrateDataFromPreviousStorage(){const e=en.storage.entries.value,t=[Jn,Xn,Zn];Object.keys(e).forEach(n=>{const s=n,i=e[s]?.type,r=this.storeManager?.getStore(os[i]);r&&t.forEach(e=>{const t=this.storeManager?.getStore(os[e]);if(t&&e!==i){const e=t.get(ts[s]);(e=>A(e)&&""!==e)(e)&&r.set(ts[s],e),t.remove(ts[s])}})})}migrateStorageIfNeeded(e,t){if(!en.storage.migrate.value)return;let n=e??[];if(0===n.length){[ns,ss,is].forEach(e=>{const t=this.storeManager?.getStore(e);t&&n.push(t)})}(t??Object.keys(ts)).forEach(e=>{const t=ts[e];n.forEach(e=>{const n=this.pluginsManager?.invokeSingle("storage.migrate",t,e.engine,this.errorHandler,this.logger);E(n)||e.set(t,n)})})}getConfiguredSessionTrackingInfo(){let e,t=!1!==en.loadOptions.value.sessions.autoTrack;if(!t)return{autoTrack:t};const n=en.loadOptions.value.sessions?.timeout;ri(n)?e=n:(this.logger.warn(((e,t,n)=>`${e}${he}The session timeout value "${t}" is not a number. The default timeout of ${n} ms will be used instead.`)(X,n,Re)),e=Re),0===e&&(this.logger.warn(`${X}${he}The session timeout value is 0, which disables the automatic session tracking feature. If you want to enable session tracking, please provide a positive integer value for the timeout.`),t=!1),e>0&&e<1e4&&this.logger.warn(((e,t,n)=>`${e}${he}The session timeout value ${t} ms is less than the recommended minimum of ${n} ms. Please consider increasing the timeout value to ensure optimal performance and reliability.`)(X,e,1e4));return{timeout:e,autoTrack:t,cutOff:this.getCutOffInfo(e)}}getCutOffInfo(e){const t=en.loadOptions.value.sessions.cutOff;let n,s=!1;return!0===t.enabled&&(n=t.duration,s=!0,ri(n)?n<e&&(this.logger.warn(((e,t,n)=>`${e}${he}The session cut off duration value "${t}" ms is less than the session timeout value "${n}" ms. The cut off functionality will be disabled.`)(X,n,e)),s=!1):(this.logger.warn(((e,t,n)=>`${e}${he}The session cut off duration value "${t}" is not a number. The default cut off duration of ${n} ms will be used instead.`)(X,n,De)),n=De)),{enabled:s,duration:n}}onError(e,t,n){this.errorHandler.onError({error:e,context:X,customMessage:t,groupingHash:n})}getEncryptedCookieData(e,t){const n=[];return e.forEach(e=>{const s=t?.encrypt(ye(e.value,!1,[],this.logger));A(s)&&n.push({name:e.name,value:s})}),n}makeRequestToSetCookie(e,t){this.httpClient?.getAsyncData({url:en.serverCookies.dataServiceUrl.value,options:{method:"POST",data:ye({reqType:"setCookies",workspaceId:en.source.value?.workspaceId,data:{options:{maxAge:en.storage.cookie.value?.maxage,path:en.storage.cookie.value?.path,domain:en.storage.cookie.value?.domain,sameSite:en.storage.cookie.value?.samesite,secure:en.storage.cookie.value?.secure,expires:en.storage.cookie.value?.expires},cookies:e}}),sendRawData:!0,withCredentials:!0},isRawResponse:!0,callback:t})}setServerSideCookies(e,t,n){const s=Object.keys(e),i=()=>s.map(t=>({name:e[t].name,value:en.session[t].value})),r={};s.forEach(t=>{r[e[t].name]=n?.get(e[t].name)});const o=()=>{s.forEach(e=>{this.serverSideCookiesRequestInProgress[e]=!1})},a=()=>{i().forEach(e=>{t&&t(e.name,e.value)})};try{const l={};s.forEach(t=>{l[e[t].name]=en.session[t].value});const u=this.getEncryptedCookieData(i(),n);u.length>0?this.makeRequestToSetCookie(u,(e,s)=>{var u;o(),200===s?.xhr?.status?i().forEach(e=>{const s=r[e.name],i=n?.get(e.name);ye(l[e.name],!1,[])!==ye(i,!1,[])&&(I(s)&&I(i)&&this.logger.error(`The server failed to set the ${e.name} cookie. As a fallback, the cookies will be set client side.`),t&&t(e.name,e.value))}):(this.logger.error((u=s?.xhr?.status,`The server responded with status ${u} while setting the cookies. As a fallback, the cookies will be set client side.`)),a())}):(a(),o())}catch(e){this.onError(e,kt,kt),a(),o()}}syncValueToStorage(e){const t=en.storage.entries.value,n=t[e]?.type;if(ci(n)){const s=this.storeManager.getStore(os[n]),i=t[e]?.key,r=en.session[e].value;r&&(k(r)||D(r))?en.serverCookies.isEnabledServerSideCookies.value&&n===Jn?(this.serverSideCookiesRequestInProgress[e]=!0,this.serverSideCookieDebounceFuncs[e]&&globalThis.clearTimeout(this.serverSideCookieDebounceFuncs[e]),this.serverSideCookieDebounceFuncs[e]=globalThis.setTimeout(()=>{const t={[e]:{name:i}};this.setServerSideCookies(t,(e,t)=>{s?.set(e,t)},s)},10)):s?.set(i,r):s?.remove(i)}}registerEffects(){rs.forEach(e=>{at(()=>{this.syncValueToStorage(e)})})}setAnonymousId(e,t){let n=e;if(k(e)&&n||(n=void 0),this.isPersistenceEnabledForStorageEntry("anonymousId")){if(!n&&t){const e=this.pluginsManager?.invokeSingle("userSession.anonymousIdGoogleLinker",t);n=e}n=n||di()}else n=xt.anonymousId;en.session.anonymousId.value=n}getAnonymousId(e){const t=en.storage.entries.value.anonymousId?.type;if(ci(t)){let t=en.session.anonymousId.value;if(t&&t!==xt.anonymousId||(t=this.getEntryValue("anonymousId")),!t&&e){const n=this.pluginsManager?.invokeSingle("storage.getAnonymousId",Es,e);t=n}en.session.anonymousId.value=t||di()}return en.session.anonymousId.value}getEntryValue(e){const t=en.storage.entries.value,n=t[e]?.type;if(ci(n)){const s=this.storeManager?.getStore(os[n]);this.migrateStorageIfNeeded([s],[e]);const i=t[e]?.key;return s?.get(i)??null}return null}getExternalAnonymousIdByCookieName(e){const t=Es(Jn);return t?.isEnabled?t.getItem(e)??null:null}getUserSessionValue(e){return this.serverSideCookiesRequestInProgress[e]?en.session[e].value:this.getEntryValue(e)}getUserId(){return this.getUserSessionValue("userId")}getUserTraits(){return this.getUserSessionValue("userTraits")}getGroupId(){return this.getUserSessionValue("groupId")}getGroupTraits(){return this.getUserSessionValue("groupTraits")}getInitialReferrer(){return this.getUserSessionValue("initialReferrer")}getInitialReferringDomain(){return this.getUserSessionValue("initialReferringDomain")}getSessionInfo(){return this.getUserSessionValue("sessionInfo")}getAuthToken(){return this.getUserSessionValue("authToken")}getSessionId(){const e=this.getSessionInfo()??xt.sessionInfo;return e.autoTrack&&!ai(e)||e.manualTrack?e.id??null:null}refreshSession(){let e=this.getSessionInfo()??xt.sessionInfo;(e.autoTrack||e.manualTrack)&&(e.autoTrack&&(this.startOrRenewAutoTracking(e),e=en.session.sessionInfo.value),void 0===e.sessionStart?e={...e,sessionStart:!0}:e.sessionStart&&(e={...e,sessionStart:!1})),en.session.sessionInfo.value=e,"readyExecuted"!==en.lifecycle.status.value&&this.syncValueToStorage("sessionInfo")}resetAndStartNewSession(){const e=en.session,{manualTrack:t,autoTrack:n,timeout:s,cutOff:i}=e.sessionInfo.value;if(n){const t={...xt.sessionInfo,timeout:s};i&&(t.cutOff={enabled:i.enabled,duration:i.duration}),e.sessionInfo.value=t,this.startOrRenewAutoTracking(e.sessionInfo.value)}else t&&this.startManualTrackingInternal()}reset(e){const{session:t}=en,n=(e=>{if("boolean"==typeof e){const{entries:t,...n}=Ut;return{...n,entries:{...t,anonymousId:e}}}return $(e)&&$(e.entries)?O(Ut,e):{...Ut}})(e);Ge(()=>{Object.keys(xt).forEach(e=>{const s=e;if(!0===n.entries[s])switch(e){case"anonymousId":this.setAnonymousId();break;case"sessionInfo":this.resetAndStartNewSession();break;default:t[s].value=xt[s]}})})}setUserId(e){en.session.userId.value=this.isPersistenceEnabledForStorageEntry("userId")&&e?e:xt.userId}setUserTraits(e){en.session.userTraits.value=this.isPersistenceEnabledForStorageEntry("userTraits")&&$(e)?O(en.session.userTraits.value??xt.userTraits,e):xt.userTraits}setGroupId(e){en.session.groupId.value=this.isPersistenceEnabledForStorageEntry("groupId")&&e?e:xt.groupId}setGroupTraits(e){en.session.groupTraits.value=this.isPersistenceEnabledForStorageEntry("groupTraits")&&$(e)?O(en.session.groupTraits.value??xt.groupTraits,e):xt.groupTraits}setInitialReferrer(e){en.session.initialReferrer.value=this.isPersistenceEnabledForStorageEntry("initialReferrer")&&e?e:xt.initialReferrer}setInitialReferringDomain(e){en.session.initialReferringDomain.value=this.isPersistenceEnabledForStorageEntry("initialReferringDomain")&&e?e:xt.initialReferringDomain}startOrRenewAutoTracking(e){let t=e;if(ai(e))t=(e=>{const{timeout:t,cutOff:n}=e,s=Date.now();return{id:s,expiresAt:s+t,timeout:t,autoTrack:!0,...n&&{cutOff:n}}})(e);else{const n=Date.now(),s=e.timeout;t.expiresAt=n+s}if(oi(t)&&(t.cutOff.expiresAt=void 0),t.cutOff){const e=(e=>{if(e?.enabled)return e.expiresAt??(ri(e.duration)?Date.now()+e.duration:void 0)})(t.cutOff);t.cutOff.expiresAt=e}en.session.sessionInfo.value=t}start(e){en.session.sessionInfo.value=ui(e,this.logger)}startManualTrackingInternal(){this.start(Date.now())}end(){en.session.sessionInfo.value=xt.sessionInfo}setAuthToken(e){en.session.authToken.value=this.isPersistenceEnabledForStorageEntry("authToken")&&e?e:xt.authToken}}const ki=["BeaconQueue","CustomConsentManager","DeviceModeDestinations","DeviceModeTransformation","ExternalAnonymousId","GoogleLinker","IubendaConsentManager","KetchConsentManager","NativeDestinationQueue","OneTrustConsentManager","StorageEncryption","StorageEncryptionLegacy","StorageMigrator","XhrQueue"],Ii="dataplaneEventsQueue",Si="destinationsEventsQueue",Ei=(e,t)=>{const n=g(e),s=t.nativeDestinations.integrationsConfig.value,i=((e,t)=>Object.keys(e).filter(n=>!0!==e[n]||!t[n]).reduce((t,n)=>{const s=g(t);return s[n]=e[n],s},{}))(e.integrations,s);return n.integrations=O(s,i),n},Ti=(e,t,n,s)=>{if(T(e))if(b(e))try{e(...t)}catch(e){s.error(`${n}${he}The callback threw an exception`,e)}else s.error(mt(n))};class Ai{constructor(e,t,n,s,i){this.pluginsManager=e,this.errorHandler=s,this.httpClient=n,this.logger=i,this.storeManager=t}init(){this.dataplaneEventsQueue=this.pluginsManager.invokeSingle(`${Ii}.init`,en,this.httpClient,this.storeManager,this.errorHandler,this.logger),this.dmtEventsQueue=this.pluginsManager.invokeSingle("transformEvent.init",en,this.pluginsManager,this.httpClient,this.storeManager,this.errorHandler,this.logger),this.destinationsEventsQueue=this.pluginsManager.invokeSingle(`${Si}.init`,en,this.pluginsManager,this.storeManager,this.dmtEventsQueue,this.errorHandler,this.logger),at(()=>{!0===en.nativeDestinations.clientDestinationsReady.value&&(this.destinationsEventsQueue?.start(),this.dmtEventsQueue?.start())});const e=(e=>e.consents.preConsent.value.enabled&&"buffer"===e.consents.preConsent.value.events?.delivery)(en);let t;at(()=>{const n=!0===en.loadOptions.value.bufferDataPlaneEventsUntilReady&&!1===en.nativeDestinations.clientDestinationsReady.value;!1!==en.nativeDestinations.activeDestinations.value.some(e=>{return t=e,Boolean("hybrid"===t.config.connectionMode||!0===t.config.useNativeSDKToSend);var t})&&!1!==n||e||!0===this.dataplaneEventsQueue?.scheduleTimeoutActive||(globalThis.clearTimeout(t),this.dataplaneEventsQueue?.start())}),!0===en.loadOptions.value.bufferDataPlaneEventsUntilReady&&(t=globalThis.setTimeout(()=>{!0!==this.dataplaneEventsQueue?.scheduleTimeoutActive&&this.dataplaneEventsQueue?.start()},en.loadOptions.value.dataPlaneEventsBufferTimeout))}resume(){!0!==this.dataplaneEventsQueue?.scheduleTimeoutActive&&(en.consents.postConsent.value.discardPreConsentEvents&&(this.dataplaneEventsQueue?.clear(),this.destinationsEventsQueue?.clear()),this.dataplaneEventsQueue?.start())}enqueue(e,t){const n=Ei(e,en);this.pluginsManager.invokeSingle(`${Ii}.enqueue`,en,this.dataplaneEventsQueue,n,this.errorHandler,this.logger);const s=g(e);this.pluginsManager.invokeSingle(`${Si}.enqueue`,en,this.destinationsEventsQueue,s,this.errorHandler,this.logger);const i=`${e.type.charAt(0).toUpperCase()}${e.type.slice(1)}${z}`;Ti(t,[n],i,this.logger)}}const wi=e=>{const t=new CustomEvent(e,{detail:{analyticsInstance:globalThis.rudderanalytics},bubbles:!0,cancelable:!0,composed:!0});globalThis.document.dispatchEvent(t)};class Ci{constructor(){this.preloadBuffer=new lt,this.initialized=!1,this.errorHandler=Ln,this.logger=dt,this.externalSrcLoader=new _e(this.logger),this.httpClient=An,this.httpClient.init(this.errorHandler),this.capabilitiesManager=new ei(this.httpClient,this.errorHandler,this.logger)}load(e,t,n={}){en.lifecycle.status.value||((e=>k(e)&&e.trim().length>0)(e)?(e=>Ns(e))(t)?(Ge(()=>{en.lifecycle.writeKey.value=g(e),en.lifecycle.dataPlaneUrl.value=g(t),en.loadOptions.value=((e,t)=>{const n=g(t);return k(n.setCookieDomain)||(n.setCookieDomain=void 0),["Strict","Lax","None"].includes(n.sameSiteCookie)||(n.sameSiteCookie=void 0),n.secureCookie=L(n.secureCookie,e.secureCookie),n.sameDomainCookiesOnly=L(n.sameDomainCookiesOnly,e.sameDomainCookiesOnly),["none","default","full"].includes(n.uaChTrackLevel)||(n.uaChTrackLevel=void 0),n.integrations=M(n.integrations),Array.isArray(n.plugins)||(n.plugins=ki),n.useGlobalIntegrationsConfigInEvents=L(n.useGlobalIntegrationsConfigInEvents,e.useGlobalIntegrationsConfigInEvents),n.bufferDataPlaneEventsUntilReady=L(n.bufferDataPlaneEventsUntilReady,e.bufferDataPlaneEventsUntilReady),n.sendAdblockPage=L(n.sendAdblockPage,e.sendAdblockPage),n.useServerSideCookies=L(n.useServerSideCookies,e.useServerSideCookies),k(n.dataServiceEndpoint)||(n.dataServiceEndpoint=void 0),n.sendAdblockPageOptions=M(n.sendAdblockPageOptions),n.loadIntegration=L(n.loadIntegration,e.loadIntegration),D(n.storage)?(n.storage.migrate=L(n.storage.migrate,e.storage?.migrate),n.storage.cookie=M(n.storage.cookie),n.storage.encryption=M(n.storage.encryption),n.storage=N(n.storage)):n.storage=void 0,n.destinationsQueueOptions=M(n.destinationsQueueOptions),n.queueOptions=M(n.queueOptions),n.lockIntegrationsVersion=L(n.lockIntegrationsVersion,e.lockIntegrationsVersion),n.lockPluginsVersion=L(n.lockPluginsVersion,e.lockPluginsVersion),ii(n.dataPlaneEventsBufferTimeout)||(n.dataPlaneEventsBufferTimeout=void 0),n.beaconQueueOptions=M(n.beaconQueueOptions),n.preConsent=M(n.preConsent),n.sourceConfigurationOverride=M(n.sourceConfigurationOverride),O(e,N(n))})(en.loadOptions.value,n),en.lifecycle.status.value="mounted"}),this.logger.setMinLogLevel(en.loadOptions.value.logLevel??ct),Me("state",en,e),this.startLifecycle()):this.logger.error(((e,t)=>`${e}${he}The data plane URL "${t}" is invalid. It must be a valid URL string. Please check that the data plane URL is correct and try again.`)(ne,t)):this.logger.error(((e,t)=>`${e}${he}The write key "${t}" is invalid. It must be a non-empty string. Please check that the write key is correct and try again.`)(ne,e)))}startLifecycle(){at(()=>{try{switch(en.lifecycle.status.value){case"mounted":this.onMounted();break;case"browserCapabilitiesReady":this.onBrowserCapabilitiesReady();break;case"configured":this.onConfigured();break;case"pluginsLoading":case"destinationsLoading":case"readyExecuted":default:break;case"pluginsReady":this.onPluginsReady();break;case"initialized":this.onInitialized();break;case"loaded":this.onLoaded();break;case"destinationsReady":this.onDestinationsReady();break;case"ready":this.onReady()}}catch(e){const t="Failed to load the SDK";this.errorHandler.onError({error:e,context:ne,customMessage:t,groupingHash:t})}})}onBrowserCapabilitiesReady(){xe(this),this.prepareInternalServices(),this.loadConfig()}onLoaded(){this.processBufferedEvents(),!0===en.consents.preConsent.value.enabled?en.lifecycle.status.value="ready":this.loadDestinations()}onMounted(){this.capabilitiesManager.init()}enqueuePreloadBufferEvents(e){Array.isArray(e)&&e.forEach(e=>this.preloadBuffer.enqueue(g(e)))}processDataInPreloadBuffer(){for(;this.preloadBuffer.size()>0;){const e=this.preloadBuffer.dequeue();e&&Ue([...e],this)}}prepareInternalServices(){this.pluginsManager=new Wn(Bn,this.errorHandler,this.logger),this.storeManager=new ws(this.pluginsManager,this.errorHandler,this.logger),this.configManager=new zs(this.httpClient,this.errorHandler,this.logger),this.userSessionManager=new bi(this.pluginsManager,this.storeManager,this.httpClient,this.errorHandler,this.logger),this.eventRepository=new Ai(this.pluginsManager,this.storeManager,this.httpClient,this.errorHandler,this.logger),this.eventManager=new mi(this.eventRepository,this.userSessionManager,this.errorHandler,this.logger)}loadConfig(){en.lifecycle.writeKey.value&&this.httpClient.setAuthHeader(en.lifecycle.writeKey.value),this.configManager?.init()}onPluginsReady(){this.storeManager?.init(),this.userSessionManager?.init(),en.consents.enabled.value&&!en.consents.initialized.value&&(this.pluginsManager?.invokeSingle("consentManager.init",en,this.logger),!1===en.consents.preConsent.value.enabled&&this.pluginsManager?.invokeSingle("consentManager.updateConsentsInfo",en,this.storeManager,this.logger)),this.eventManager?.init(),en.lifecycle.status.value="initialized"}onConfigured(){this.pluginsManager?.init()}onInitialized(){this.processDataInPreloadBuffer(),Ge(()=>{en.lifecycle.loaded.value=!0,en.lifecycle.status.value="loaded"}),this.initialized=!0;const e=en.loadOptions.value.onLoaded;Ti(e,[globalThis.rudderanalytics],te,this.logger),wi("RSA_Initialised")}onReady(){en.lifecycle.status.value="readyExecuted",en.eventBuffer.readyCallbacksArray.value.forEach(e=>{Ti(e,[],ee,this.logger)}),wi("RSA_Ready")}processBufferedEvents(){let e=en.eventBuffer.toBeProcessedArray.value;for(;e.length>0;){const t=e.shift();if(en.eventBuffer.toBeProcessedArray.value=e,t){const e=t[0];b(this[e])&&this[e](...t.slice(1),!0)}e=en.eventBuffer.toBeProcessedArray.value}}loadDestinations(){if("destinationsLoading"===en.lifecycle.status.value||"destinationsReady"===en.lifecycle.status.value)return;this.pluginsManager?.invokeSingle("nativeDestinations.setActiveDestinations",en,this.pluginsManager,this.errorHandler,this.logger);const e=en.nativeDestinations.activeDestinations.value.length;0!==e?(en.lifecycle.status.value="destinationsLoading",this.pluginsManager?.invokeSingle("nativeDestinations.load",en,this.externalSrcLoader,this.errorHandler,this.logger),at(()=>{(0===e||en.nativeDestinations.initializedDestinations.value.length+en.nativeDestinations.failedDestinations.value.length===e)&&Ge(()=>{en.lifecycle.status.value="destinationsReady",en.nativeDestinations.clientDestinationsReady.value=!0})})):en.lifecycle.status.value="destinationsReady"}onDestinationsReady(){"ready"!==en.lifecycle.status.value&&(en.lifecycle.status.value="ready")}ready(e,t=!1){const n="ready";en.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb(`New ${n} invocation`),b(e)?"readyExecuted"===en.lifecycle.status.value?Ti(e,[],ee,this.logger):en.eventBuffer.readyCallbacksArray.value=[...en.eventBuffer.readyCallbacksArray.value,e]:this.logger.error(mt(ee))):en.eventBuffer.toBeProcessedArray.value=[...en.eventBuffer.toBeProcessedArray.value,[n,e]]}page(e,t=!1){const n="page";en.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb(`New ${n} event`),en.metrics.triggered.value+=1,this.eventManager?.addEvent({type:"page",category:e.category,name:e.name,properties:e.properties,options:e.options,callback:e.callback}),!0===en.capabilities.isAdBlocked.value&&e.category!==Ce&&this.page(_(Ce,"ad-block page request",{path:"/ad-blocked"},en.loadOptions.value.sendAdblockPageOptions))):en.eventBuffer.toBeProcessedArray.value=[...en.eventBuffer.toBeProcessedArray.value,[n,e]]}track(e,t=!1){const n="track";en.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb(`New ${n} event - ${e.name}`),en.metrics.triggered.value+=1,this.eventManager?.addEvent({type:n,name:e.name||void 0,properties:e.properties,options:e.options,callback:e.callback})):en.eventBuffer.toBeProcessedArray.value=[...en.eventBuffer.toBeProcessedArray.value,[n,e]]}identify(e,t=!1){const n="identify";if(!en.lifecycle.loaded.value)return void(en.eventBuffer.toBeProcessedArray.value=[...en.eventBuffer.toBeProcessedArray.value,[n,e]]);this.errorHandler.leaveBreadcrumb(`New ${n} event`),en.metrics.triggered.value+=1;Boolean(e.userId&&en.session.userId.value&&e.userId!==en.session.userId.value)&&this.reset(),I(e.userId)||this.userSessionManager?.setUserId(e.userId),this.userSessionManager?.setUserTraits(e.traits),this.eventManager?.addEvent({type:n,userId:e.userId,traits:e.traits,options:e.options,callback:e.callback})}alias(e,t=!1){const n="alias";if(!en.lifecycle.loaded.value)return void(en.eventBuffer.toBeProcessedArray.value=[...en.eventBuffer.toBeProcessedArray.value,[n,e]]);this.errorHandler.leaveBreadcrumb(`New ${n} event`),en.metrics.triggered.value+=1;const s=e.from??(this.getUserId()||this.userSessionManager?.getAnonymousId());this.eventManager?.addEvent({type:n,to:e.to,from:s,options:e.options,callback:e.callback})}group(e,t=!1){const n="group";en.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb(`New ${n} event`),en.metrics.triggered.value+=1,I(e.groupId)||this.userSessionManager?.setGroupId(e.groupId),this.userSessionManager?.setGroupTraits(e.traits),this.eventManager?.addEvent({type:n,groupId:e.groupId,traits:e.traits,options:e.options,callback:e.callback})):en.eventBuffer.toBeProcessedArray.value=[...en.eventBuffer.toBeProcessedArray.value,[n,e]]}reset(e,t=!1){const n="reset";en.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb(`New ${n} invocation`),this.userSessionManager?.reset(e)):en.eventBuffer.toBeProcessedArray.value=[...en.eventBuffer.toBeProcessedArray.value,[n,e]]}getAnonymousId(e){return this.userSessionManager?.getAnonymousId(e)}setAnonymousId(e,t,n=!1){const s="setAnonymousId";en.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb(`New ${s} invocation`),this.userSessionManager?.setAnonymousId(e,t)):en.eventBuffer.toBeProcessedArray.value=[...en.eventBuffer.toBeProcessedArray.value,[s,e,t]]}getUserId(){return en.session.userId.value}getUserTraits(){return en.session.userTraits.value}getGroupId(){return en.session.groupId.value}getGroupTraits(){return en.session.groupTraits.value}startSession(e,t=!1){const n="startSession";en.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb(`New ${n} invocation`),this.userSessionManager?.start(e)):en.eventBuffer.toBeProcessedArray.value=[...en.eventBuffer.toBeProcessedArray.value,[n,e]]}endSession(e=!1){const t="endSession";en.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb(`New ${t} invocation`),this.userSessionManager?.end()):en.eventBuffer.toBeProcessedArray.value=[...en.eventBuffer.toBeProcessedArray.value,[t]]}getSessionId(){const e=this.userSessionManager?.getSessionId();return e??null}consent(e,t=!1){en.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb("New consent invocation"),Ge(()=>{en.consents.preConsent.value={...en.consents.preConsent.value,enabled:!1},en.consents.postConsent.value=(e=>{const t={sendPageEvent:!1,trackConsent:!1,discardPreConsentEvents:!1};if($(e)){const n=g(e);t.storage=n.storage,D(n.integrations)&&(t.integrations=n.integrations),t.discardPreConsentEvents=!0===n.discardPreConsentEvents,t.sendPageEvent=!0===n.sendPageEvent,t.trackConsent=!0===n.trackConsent,D(n.consentManagement)&&(t.consentManagement=O(n.consentManagement,{enabled:en.consents.enabled.value}))}return t})(e);const{initialized:t,consentsData:n}=Us(en.consents.postConsent.value.consentManagement,this.logger);en.consents.initialized.value=t,en.consents.data.value=n}),en.consents.enabled.value&&!en.consents.initialized.value&&this.pluginsManager?.invokeSingle("consentManager.updateConsentsInfo",en,this.storeManager,this.logger),this.storeManager?.initializeStorageState(),this.userSessionManager?.syncStorageDataToState(),this.eventManager?.resume(),this.loadDestinations(),this.sendTrackingEvents(t)):en.eventBuffer.toBeProcessedArray.value=[...en.eventBuffer.toBeProcessedArray.value,["consent",e]]}sendTrackingEvents(e){if(en.consents.postConsent.value.trackConsent){const t=H("Consent Management Interaction");e?en.eventBuffer.toBeProcessedArray.value=[...en.eventBuffer.toBeProcessedArray.value,["track",t]]:this.track(t)}if(en.consents.postConsent.value.sendPageEvent){const t=_();e?en.eventBuffer.toBeProcessedArray.value=[...en.eventBuffer.toBeProcessedArray.value,["page",t]]:this.page(t)}}setAuthToken(e){this.userSessionManager?.setAuthToken(e)}addCustomIntegration(e,t,n=!1){const s="addCustomIntegration";if(n)this.errorHandler.leaveBreadcrumb(`New ${s} invocation`),this.pluginsManager?.invokeSingle("nativeDestinations.addCustomIntegration",e,t,en,this.logger);else{if(en.lifecycle.loaded.value)return void this.logger.error(((e,t)=>`${e}${he}Cannot add custom integration for destination ID "${t}" after the SDK is loaded.`)(ne,e));en.eventBuffer.toBeProcessedArray.value=[...en.eventBuffer.toBeProcessedArray.value,[s,e,t]]}}}class $i{static globalSingleton=null;analyticsInstances={};defaultAnalyticsKey="";logger=dt;constructor(){try{if($i.globalSingleton)return $i.globalSingleton;$i.initializeGlobalResources(),this.setDefaultInstanceKey=this.setDefaultInstanceKey.bind(this),this.getAnalyticsInstance=this.getAnalyticsInstance.bind(this),this.load=this.load.bind(this),this.ready=this.ready.bind(this),this.triggerBufferedLoadEvent=this.triggerBufferedLoadEvent.bind(this),this.page=this.page.bind(this),this.track=this.track.bind(this),this.identify=this.identify.bind(this),this.alias=this.alias.bind(this),this.group=this.group.bind(this),this.reset=this.reset.bind(this),this.getAnonymousId=this.getAnonymousId.bind(this),this.setAnonymousId=this.setAnonymousId.bind(this),this.getUserId=this.getUserId.bind(this),this.getUserTraits=this.getUserTraits.bind(this),this.getGroupId=this.getGroupId.bind(this),this.getGroupTraits=this.getGroupTraits.bind(this),this.startSession=this.startSession.bind(this),this.endSession=this.endSession.bind(this),this.getSessionId=this.getSessionId.bind(this),this.setAuthToken=this.setAuthToken.bind(this),this.consent=this.consent.bind(this),this.addCustomIntegration=this.addCustomIntegration.bind(this),this.createSafeAnalyticsInstance(),$i.globalSingleton=this,en.autoTrack.pageLifecycle.pageViewId.value=ce(),en.autoTrack.pageLifecycle.pageLoadedTimestamp.value=Date.now(),this.triggerBufferedLoadEvent(),globalThis.rudderanalytics=this}catch(e){Te(e)}}createSafeAnalyticsInstance(){en.lifecycle.safeAnalyticsInstance.value={page:this.page.bind(this),track:this.track.bind(this),identify:this.identify.bind(this),alias:this.alias.bind(this),group:this.group.bind(this),getAnonymousId:this.getAnonymousId.bind(this),getUserId:this.getUserId.bind(this),getUserTraits:this.getUserTraits.bind(this),getGroupId:this.getGroupId.bind(this),getGroupTraits:this.getGroupTraits.bind(this),getSessionId:this.getSessionId.bind(this)}}static initializeGlobalResources(){Ln.init(),Ss.configure(),ks.configure(),Is.configure(),hs.configure()}setDefaultInstanceKey(e){k(e)&&e&&(this.defaultAnalyticsKey=e)}getAnalyticsInstance(e){try{let t=e;k(t)&&t||(t=this.defaultAnalyticsKey);return Boolean(this.analyticsInstances[t])||(this.analyticsInstances[t]=new Ci),this.analyticsInstances[t]}catch(e){return void Te(e)}}load(e,t,n){try{if(this.analyticsInstances[e])return;this.setDefaultInstanceKey(e),this.trackPageLifecycleEvents(n);const s=Le($e);(e=>{const t="consent",n=e.filter(e=>e[0]===t),s=e.filter(e=>e[0]!==t);e.splice(0,e.length,...n,...s)})(s),Me($e,g(s)),this.getAnalyticsInstance(e)?.load(e,t,ke(n))}catch(e){Te(e)}}trackPageLifecycleEvents(e){const{autoTrack:t,useBeacon:n}=e??{},{enabled:s=!1,options:i={},pageLifecycle:r}=t??{},{events:o=[V.UNLOADED],enabled:a=s,options:l=i}=r??{};en.autoTrack.pageLifecycle.enabled.value=a,en.autoTrack.enabled.value=s||a,a&&this.setupPageUnloadTracking(o,n,l)}setupPageUnloadTracking(e,t,n){(0===e.length||e.includes(V.UNLOADED))&&(!0===t?((e,t=!1)=>{let n=!1,s=!1;function i(){n||(n=!0,e(s),setTimeout(()=>{n=!1},0))}(t||de())&&globalThis.addEventListener("beforeunload",()=>{s=!1,i()}),globalThis.addEventListener("blur",()=>{s=!0,i()}),globalThis.addEventListener("focus",()=>{n=!1}),document.addEventListener("pagehide",()=>{s="hidden"===document.visibilityState,i()}),document.addEventListener("visibilitychange",()=>{s=!0,"hidden"===document.visibilityState?i():n=!1})})(e=>{if(!1===e&&en.lifecycle.loaded.value){const e=Date.now(),t=e-en.autoTrack.pageLifecycle.pageLoadedTimestamp.value;this.track(V.UNLOADED,{timeOnPage:t},{...n,originalTimestamp:ge(new Date(e))})}},!0):this.logger.warn(`${"RudderStackAnalytics"}${he}Page Unloaded event can only be tracked when the Beacon transport is active. Please enable "useBeacon" load API option.`))}triggerBufferedLoadEvent(){const e=Array.isArray(globalThis.rudderanalytics)?globalThis.rudderanalytics:[],t=(e=>{let t=[],n=0;for(;n<e.length;){if(e[n]&&"load"===e[n][0]){t=g(e[n]),e.splice(n,1);break}n+=1}return t})(e);Me($e,g([...e])),t.length>0&&(t.shift(),this.load.apply(null,t))}ready(e){try{this.getAnalyticsInstance()?.ready(ke(e))}catch(e){Te(e)}}page(e,t,n,s,i){try{this.getAnalyticsInstance()?.page(_(ke(e),ke(t),ke(n),ke(s),ke(i)))}catch(e){Te(e)}}track(e,t,n,s){try{this.getAnalyticsInstance()?.track(H(ke(e),ke(t),ke(n),ke(s)))}catch(e){Te(e)}}identify(e,t,n,s){try{this.getAnalyticsInstance()?.identify(F(ke(e),ke(t),ke(n),ke(s)))}catch(e){Te(e)}}alias(e,t,n,s){try{this.getAnalyticsInstance()?.alias(G(ke(e),ke(t),ke(n),ke(s)))}catch(e){Te(e)}}group(e,t,n,s){try{this.getAnalyticsInstance()?.group(K(ke(e),ke(t),ke(n),ke(s)))}catch(e){Te(e)}}reset(e){try{this.getAnalyticsInstance()?.reset(ke(e))}catch(e){Te(e)}}getAnonymousId(e){try{return this.getAnalyticsInstance()?.getAnonymousId(ke(e))}catch(e){return void Te(e)}}setAnonymousId(e,t){try{this.getAnalyticsInstance()?.setAnonymousId(ke(e),ke(t))}catch(e){Te(e)}}getUserId(){try{return this.getAnalyticsInstance()?.getUserId()}catch(e){return void Te(e)}}getUserTraits(){try{return this.getAnalyticsInstance()?.getUserTraits()}catch(e){return void Te(e)}}getGroupId(){try{return this.getAnalyticsInstance()?.getGroupId()}catch(e){return void Te(e)}}getGroupTraits(){try{return this.getAnalyticsInstance()?.getGroupTraits()}catch(e){return void Te(e)}}startSession(e){try{this.getAnalyticsInstance()?.startSession(ke(e))}catch(e){Te(e)}}endSession(){try{this.getAnalyticsInstance()?.endSession()}catch(e){Te(e)}}getSessionId(){try{return this.getAnalyticsInstance()?.getSessionId()}catch(e){return void Te(e)}}setAuthToken(e){try{this.getAnalyticsInstance()?.setAuthToken(ke(e))}catch(e){Te(e)}}consent(e){try{this.getAnalyticsInstance()?.consent(ke(e))}catch(e){Te(e)}}addCustomIntegration(e,t){try{this.getAnalyticsInstance()?.addCustomIntegration(ke(e),ke(t))}catch(e){Te(e)}}}const{setDefaultInstanceKey:Pi,getAnalyticsInstance:Oi,load:Di,ready:Ri,page:Ni,track:Mi,identify:Li,alias:Bi,group:xi,reset:Ui,getAnonymousId:ji,setAnonymousId:_i,getUserId:Hi,getUserTraits:Fi,getGroupId:Gi,getGroupTraits:Ki,startSession:Vi,endSession:zi,getSessionId:Qi,consent:qi,setAuthToken:Wi,addCustomIntegration:Ji}=new $i;return e.addCustomIntegration=Ji,e.alias=Bi,e.consent=qi,e.endSession=zi,e.getAnalyticsInstance=Oi,e.getAnonymousId=ji,e.getGroupId=Gi,e.getGroupTraits=Ki,e.getSessionId=Qi,e.getUserId=Hi,e.getUserTraits=Fi,e.group=xi,e.identify=Li,e.load=Di,e.page=Ni,e.ready=Ri,e.reset=Ui,e.setAnonymousId=_i,e.setAuthToken=Wi,e.setDefaultInstanceKey=Pi,e.startSession=Vi,e.track=Mi,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),e}({});
//# sourceMappingURL=rsa.min.js.map
